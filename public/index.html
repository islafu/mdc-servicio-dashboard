<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MDC Digital — Reporte de Actividades Asesores CAD-CAM</title>

  <!-- CSS de producción (Tailwind compilado). Si no existe, CDN fallback -->
  <link rel="stylesheet" href="/styles.css">
  <script>
    (async () => {
      try {
        const r = await fetch('/styles.css', { cache: 'no-store' });
        if (!r.ok) throw 0;
        const len = +(r.headers.get('content-length') || 0);
        if (len < 10240) throw 0;
      } catch {
        const s = document.createElement('script');
        s.src = 'https://cdn.tailwindcss.com';
        document.head.appendChild(s);
        console.warn('Usando Tailwind CDN fallback (compila styles.css para producción)');
      }
    })();
  </script>

  <!-- Librerías -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.min.js"></script>
  <script>dayjs.extend(window.dayjs_plugin_isoWeek);dayjs.extend(window.dayjs_plugin_customParseFormat);dayjs.extend(window.dayjs_plugin_isBetween);</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/core/locales-all.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{color-scheme:dark}
    body{background:#0b0d10;color:#e5e7eb}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);border-radius:1rem}
    .formc{background-color:#1e293b;color:#f1f5f9;border:1px solid #334155}
    .formc::placeholder{color:#cbd5e1}
    select.formc option{color:#000}
    .btn{display:inline-flex;align-items:center;gap:.4rem;border:1px solid rgba(255,255,255,.12);padding:.35rem .6rem;border-radius:.5rem}
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn-primary{border-color:rgba(59,130,246,.5)}
    .btn-primary:hover{background:rgba(59,130,246,.12)}
    .chip{display:inline-block;padding:.1rem .5rem;border-radius:.375rem;border:1px solid rgba(255,255,255,.15);font-size:.75rem}
    .chip-warn{background:rgba(234,179,8,.12);border-color:rgba(234,179,8,.35)}
    .chip-ok{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
    .table-viewport { max-height: 65vh; overflow: auto; }
    #tbl { table-layout: auto; border-collapse: separate; border-spacing: 0; width: max-content; min-width: 100%; }
    #tbl thead th { position: sticky; top: 0; background: #0f172a; z-index: 1; }
    #tbl th, #tbl td { font-size: .92rem; line-height: 1.25rem; white-space: nowrap; vertical-align: top; }
    #tbl td { padding-top:.5rem; padding-bottom:.5rem; }
    .col-money { text-align: right; min-width: 7.5rem; }
    .col-horas { text-align: right; min-width: 6rem; }
    .col-notas { white-space: normal; min-width: 20rem; max-width: 40rem; }
    .col-acciones { white-space: nowrap; min-width: 10rem; }
    canvas { max-width: 100%; }
    .chart-h { height: 320px; }
    .chart-h-lg { height: 360px; }
    #map{min-height:460px;height:460px}
    #calendar{min-height:960px;height:auto}
    .modal-bg{position:fixed;inset:0;background:rgba(2,6,23,.72);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{background:#0b1220;border:1px solid rgba(255,255,255,.08);border-radius:1rem;max-width:42rem;width:92%;padding:1rem}
  </style>
</head>
<body class="h-full">
<div class="max-w-7xl mx-auto p-4 sm:p-6">

  <!-- Header -->
  <header class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-6">
    <div class="flex items-center gap-3">
      <img src="/logo-mdc.png" alt="MDC Digital" class="h-10 w-auto rounded-sm">
      <div>
        <h1 class="text-2xl font-semibold">MDC Digital — Reporte de Actividades Asesores CAD-CAM</h1>
        <p class="text-slate-400 text-sm">Captura · KPIs · Gráficas · Mapas · Calendario · PDF</p>
      </div>
    </div>
    <div class="flex flex-wrap gap-2">
      <select id="fMes" class="px-3 py-2 rounded-lg formc"></select>
      <button id="btnExportPdf" class="btn bg-emerald-600/80 hover:bg-emerald-600 text-white">🧾 Exportar PDF</button>
    </div>
  </header>

  <!-- KPIs principales -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3 mb-6">
    <div class="card p-4"><div class="text-slate-400 text-xs">Total registros</div><div id="kpiC_total" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs">Soporte</div><div id="kpiC_soporte" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs">Instalaciones</div><div id="kpiC_inst" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs">Eventos/Proy./Cursos</div><div id="kpiC_eventos" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs">Conexiones TV (mes)</div><div id="kpiC_tvconn" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs">Horas TV (mes)</div><div id="kpiC_tvhrs" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs">Equipos instalados — Subtotal</div><div id="kpiEqSub" class="text-2xl font-semibold mt-1">$0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs">Equipos instalados — Total c/IVA</div><div id="kpiEqTot" class="text-2xl font-semibold mt-1">$0</div></div>
  </section>

  <!-- KPIs financieros -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Potencial no cobrado (garantía)</div>
      <div id="kpiPotGarantia" class="text-3xl font-semibold mt-1">$0</div>
      <div class="text-slate-400 text-xs mt-1">Tarifa $1,000/h</div>
    </div>
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Total cobrado</div>
      <div class="text-3xl font-semibold mt-1" id="kpiCobradoTotal">$0</div>
      <div class="text-slate-400 text-xs mt-1">
        MO: <span id="kpiMo">$0</span> · Ref: <span id="kpiRef">$0</span> · Via: <span id="kpiVia">$0</span> · IVA: <span id="kpiIva">$0</span>
      </div>
    </div>
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Instalaciones — Costo empresa</div>
      <div id="kpiInstCosto" class="text-3xl font-semibold mt-1">$0</div>
      <div class="text-slate-400 text-xs mt-1">85/h + viáticos</div>
    </div>
  </section>

  <!-- Gráficas + TeamViewer -->
  <section class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-6">
    <div class="card p-4"><h3 class="text-lg font-medium mb-3">Actividades por asesor (apilado por tipo)</h3><div class="chart-h"><canvas id="chartActAsesor"></canvas></div></div>
    <div class="card p-4"><h3 class="text-lg font-medium mb-3">Remoto vs Presencial</h3><div class="chart-h"><canvas id="chartRemoto"></canvas></div></div>
    <div class="card p-4"><h3 class="text-lg font-medium mb-3">Distribución por actividad</h3><div class="chart-h"><canvas id="chartActividad"></canvas></div></div>
    <div class="card p-4"><h3 class="text-lg font-medium mb-3">Garantía vs No garantía</h3><div class="chart-h"><canvas id="chartGarantia"></canvas></div></div>

    <div class="card p-4 xl:col-span-2">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-medium">TeamViewer — Totales del mes</h3>
        <div class="text-xs text-slate-400">Fuente: /connectionreport.csv</div>
      </div>
      <div class="chart-h"><canvas id="chartTV"></canvas></div>
      <div class="mt-4 table-viewport">
        <table class="w-full" id="tvTable">
          <thead>
            <tr class="text-left text-slate-400">
              <th class="py-2 px-3">Periodo</th>
              <th class="py-2 px-3">Conexiones</th>
              <th class="py-2 px-3">Horas</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card p-4 xl:col-span-2"><h3 class="text-lg font-medium mb-3">Ingresos por asesor (MXN)</h3><div class="chart-h-lg"><canvas id="chartIngresos"></canvas></div></div>
  </section>

  <!-- Mapa y Calendario -->
  <section class="grid grid-cols-1 gap-6 mb-6">
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-medium">Mapa</h3>
        <div class="text-xs text-slate-400">Geolocalización por registro (lat/lng)</div>
      </div>
      <div id="map" class="rounded-lg overflow-hidden"></div>
    </div>
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-medium">Calendario de actividades</h3>
        <div class="text-xs text-slate-400">Vista mensual · colores por actividad</div>
      </div>
      <div id="calendar" class="rounded-lg bg-slate-900"></div>
    </div>
  </section>

  <!-- CAPTURA -->
  <section class="card p-4 mb-6">
    <h2 class="text-lg font-medium mb-3">Captura de registro</h2>
    <form id="frm" class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <!-- Fechas/Horas con modal -->
      <div>
        <div class="text-xs text-slate-400 mb-1">Inicio</div>
        <div class="flex gap-2">
          <input class="formc px-3 py-2 rounded grow" name="fecha_inicio" placeholder="Fecha inicio (YYYY-MM-DD)" readonly />
          <input class="formc px-3 py-2 rounded w-28" name="hora_inicio" placeholder="HH:MM" readonly />
          <button type="button" id="btnFHini" class="btn">🗓️</button>
        </div>
      </div>
      <div>
        <div class="text-xs text-slate-400 mb-1">Fin</div>
        <div class="flex gap-2">
          <input class="formc px-3 py-2 rounded grow" name="fecha_fin" placeholder="Fecha fin (YYYY-MM-DD)" readonly />
          <input class="formc px-3 py-2 rounded w-28" name="hora_fin" placeholder="HH:MM" readonly />
          <button type="button" id="btnFHfin" class="btn">🗓️</button>
        </div>
      </div>

      <input class="formc px-3 py-2 rounded" name="asesor" placeholder="Asesor" />
      <select class="formc px-3 py-2 rounded" name="actividad">
        <option value="">Actividad</option>
        <option>Soporte de garantía</option>
        <option>Soporte fuera de garantía</option>
        <option>Instalación</option>
        <option>Evento</option>
        <option>Proyecto</option>
        <option>Curso</option>
        <option>Vacaciones</option>
      </select>
      <select class="formc px-3 py-2 rounded" name="modalidad">
        <option value="">Modalidad</option>
        <option>Remoto</option>
        <option>Presencial</option>
      </select>
      <select class="formc px-3 py-2 rounded" name="garantia">
        <option value="">¿Garantía?</option>
        <option>Sí</option>
        <option>No</option>
      </select>

      <input class="formc px-3 py-2 rounded" name="cliente" placeholder="Cliente" />
      <input class="formc px-3 py-2 rounded" name="telefono" placeholder="Teléfono" />
      <input class="formc px-3 py-2 rounded" name="ciudad" placeholder="Ciudad" />

      <!-- Dirección con Autocomplete -->
      <div class="md:col-span-2">
        <div class="text-xs text-slate-400 mb-1">Dirección (Maps)</div>
        <div id="placeBox" class="w-full"></div>
      </div>

      <input class="formc px-3 py-2 rounded" name="lat" placeholder="Latitud" />
      <input class="formc px-3 py-2 rounded" name="lng" placeholder="Longitud" />
      <textarea class="formc px-3 py-2 rounded md:col-span-2" name="notas" placeholder="Notas"></textarea>

      <!-- Costeo e IVA auto 16% -->
      <input class="formc px-3 py-2 rounded" name="mo_monto" placeholder="Mano de obra (sin IVA)" />
      <input class="formc px-3 py-2 rounded" name="refacciones_monto" placeholder="Refacciones (sin IVA)" />
      <input class="formc px-3 py-2 rounded" name="viaticos_monto" placeholder="Viáticos (sin IVA)" />
      <input class="formc px-3 py-2 rounded" name="iva_monto" placeholder="IVA (auto 16%)" readonly />
      <input class="formc px-3 py-2 rounded" name="total_cobrado" placeholder="Total cobrado" readonly />

      <input class="formc px-3 py-2 rounded" name="equipos_valor_subtotal" placeholder="Equipos subtotal" />
      <input class="formc px-3 py-2 rounded" name="equipos_iva" placeholder="Equipos IVA (auto 16%)" readonly />
      <input class="formc px-3 py-2 rounded" name="equipos_valor_total" placeholder="Equipos total" readonly />

      <!-- Bloques con modal -->
      <div class="md:col-span-2">
        <div class="flex items-center justify-between">
          <div class="text-xs text-slate-400">Bloques de horas</div>
          <button type="button" id="btnBloques" class="btn">🧩 Editar bloques</button>
        </div>
        <textarea class="formc px-3 py-2 rounded w-full mt-2" name="bloques_horas" placeholder="[]" readonly></textarea>
      </div>
      <input class="formc px-3 py-2 rounded" name="horas_totales" placeholder="Horas totales" readonly />

      <div class="md:col-span-2 flex gap-2">
        <button type="button" id="btnGuardar" class="btn btn-primary">💾 Guardar</button>
        <button type="button" id="btnLimpiarForm" class="btn">Limpiar</button>
      </div>
    </form>
  </section>

  <!-- Filtros -->
  <section class="card p-4 mb-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
      <select id="fAsesor" class="px-3 py-2 rounded-lg formc">
        <option value="">Todos los asesores</option>
        <option>Israel</option><option>Selene</option><option>Diego</option><option>Yared</option><option>Gabriel</option>
      </select>
      <select id="fActividad" class="px-3 py-2 rounded-lg formc">
        <option value="">Todas las actividades</option>
        <option>Soporte de garantía</option>
        <option>Soporte fuera de garantía</option>
        <option>Instalación</option>
        <option>Evento</option>
        <option>Proyecto</option>
        <option>Curso</option>
        <option>Vacaciones</option>
      </select>
      <select id="fModalidad" class="px-3 py-2 rounded-lg formc">
        <option value="">Todas las modalidades</option>
        <option>Remoto</option>
        <option>Presencial</option>
      </select>
      <input id="fCiudad" class="px-3 py-2 rounded-lg formc" placeholder="Ciudad" />
      <input id="fRango" class="px-3 py-2 rounded-lg formc" placeholder="Rango fechas (YYYY-MM-DD a YYYY-MM-DD)" />
    </div>
    <div class="mt-3 flex gap-2">
      <button id="btnAplicarFiltros" class="btn btn-primary">Aplicar filtros</button>
      <button id="btnLimpiarFiltros" class="btn">Limpiar</button>
      <button id="btnReload" class="btn">🔄 Recargar</button>
    </div>
  </section>

  <!-- Tabla -->
  <section class="card p-4">
    <h2 class="text-lg font-medium mb-3">Registros</h2>
    <div class="table-viewport">
      <table id="tbl">
        <thead>
          <tr class="text-left text-slate-400">
            <th class="py-2 px-3">ID</th>
            <th class="py-2 px-3">Inicio</th>
            <th class="py-2 px-3">Fin</th>
            <th class="py-2 px-3">Asesor</th>
            <th class="py-2 px-3">Actividad</th>
            <th class="py-2 px-3">Modalidad</th>
            <th class="py-2 px-3 col-horas">Horas</th>
            <th class="py-2 px-3 col-money">Pot. Garantía</th>
            <th class="py-2 px-3 col-money">MO $</th>
            <th class="py-2 px-3 col-money">Ref $</th>
            <th class="py-2 px-3 col-money">Viáticos $</th>
            <th class="py-2 px-3 col-money">IVA $</th>
            <th class="py-2 px-3 col-money">Total $</th>
            <th class="py-2 px-3 col-money">Eq. Subtotal</th>
            <th class="py-2 px-3 col-money">Eq. Total</th>
            <th class="py-2 px-3 col-money">Costo Inst.</th>
            <th class="py-2 px-3">Ciudad</th>
            <th class="py-2 px-3 col-notas">Notas</th>
            <th class="py-2 px-3 col-acciones">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</div>

<!-- Modal calendario (detalle) -->
<div id="modalBg" class="modal-bg">
  <div class="modal">
    <div class="flex items-start justify-between">
      <h3 id="mTitulo" class="text-lg font-semibold">Detalle del evento</h3>
      <button id="mClose" class="btn">✖</button>
    </div>
    <div id="mBody" class="mt-2 text-slate-300 text-sm whitespace-pre-wrap"></div>
    <div class="mt-4 flex gap-2 justify-end">
      <button id="mEdit" class="btn btn-primary">✏️ Editar</button>
      <button id="mDel" class="btn">🗑️ Eliminar</button>
    </div>
  </div>
</div>

<!-- Modal Fecha/Hora -->
<div id="dlgFHbg" class="modal-bg">
  <div class="modal max-w-md">
    <h3 class="text-lg font-semibold mb-2">Seleccionar fecha y hora</h3>
    <div class="space-y-2">
      <input id="fhPicker" type="datetime-local" class="formc px-3 py-2 rounded w-full" />
      <div class="text-xs text-slate-400">Se guardará como YYYY-MM-DD y HH:MM</div>
    </div>
    <div class="mt-4 flex gap-2 justify-end">
      <button type="button" id="fhCancel" class="btn">Cancelar</button>
      <button type="button" id="fhOk" class="btn btn-primary">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Bloques -->
<div id="dlgBLbg" class="modal-bg">
  <div class="modal max-w-3xl">
    <h3 class="text-lg font-semibold mb-2">Bloques de horas</h3>

    <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
      <input id="blFecha" type="date" class="formc px-3 py-2 rounded" />
      <input id="blIni"   type="time" class="formc px-3 py-2 rounded" />
      <input id="blFin"   type="time" class="formc px-3 py-2 rounded" />
      <input id="blBreak" type="number" min="0" step="1" class="formc px-3 py-2 rounded" placeholder="Break (min)" />
      <button type="button" id="blAdd" class="btn btn-primary">➕ Agregar</button>
    </div>

    <div class="mt-3 table-viewport">
      <table class="w-full">
        <thead>
          <tr class="text-left text-slate-400">
            <th class="py-2 px-3">Fecha</th>
            <th class="py-2 px-3">Inicio</th>
            <th class="py-2 px-3">Fin</th>
            <th class="py-2 px-3">Break (min)</th>
            <th class="py-2 px-3">Min netos</th>
            <th class="py-2 px-3">—</th>
          </tr>
        </thead>
        <tbody id="blTbody"></tbody>
      </table>
    </div>

    <div class="mt-3 text-right text-slate-300">
      Total horas: <span id="blTotal" class="font-semibold">0.00</span>
    </div>

    <div class="mt-4 flex gap-2 justify-end">
      <button type="button" id="blCancel" class="btn">Cancelar</button>
      <button type="button" id="blOk" class="btn btn-primary">Guardar</button>
    </div>
  </div>
</div>

<!-- ================= JS ================= -->
<script>
/* ===== Config ===== */
const API_URL = '/.netlify/functions/gas-proxy';
const EDIT_TOKEN = '42673';
const TARIFA_GARANTIA = 1000;  // $/h
const TARIFA_INTERNA_INST = 85; // $/h
const IVA = 0.16;

/* ===== Estado ===== */
let ROWS = [];
let FILTERED = [];
let CAL = null;
const CHARTS = {};
let CAL_EVENT_CLICKED = null;

/* ===== Utils ===== */
function $(q){ return document.querySelector(q); }
function fmtMoney(n){ n = Number(n)||0; return n.toLocaleString('es-MX',{style:'currency',currency:'MXN',maximumFractionDigits:0}); }

/* ---- Normalizadores robustos ---- */
// --- helpers nuevos/actualizados ---
function toHHMM(totalMinutes){
  const mins = Math.round(totalMinutes);
  const hh = String(Math.floor((mins/60) % 24)).padStart(2,'0');
  const mm = String(mins % 60).padStart(2,'0');
  return `${hh}:${mm}`;
}

function normalizeDate(d) {
  const s = (d ?? '').toString().trim();
  const m1 = dayjs(s, ['YYYY-MM-DD','DD/MM/YYYY','MM/DD/YYYY','YYYY/MM/DD','DD-MM-YYYY'], true);
  if (m1.isValid()) return m1.format('YYYY-MM-DD');
  const iso = s.match(/^\d{4}-\d{2}-\d{2}/)?.[0];
  if (iso) return iso;
  const n = Number(s);
  // Excel serial (fecha o fecha+hora)
  if (Number.isFinite(n) && n > 59) {
    const base = dayjs('1899-12-30'); // base Excel
    return base.add(n, 'day').format('YYYY-MM-DD');
  }
  return '';
}

function normalizeTime(t) {
  if (t === null || t === undefined) return '';

  // 0) Objeto Date
  if (Object.prototype.toString.call(t) === '[object Date]') {
    if (!isNaN(t)) return `${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
  }

  const s = String(t).trim();
  if (!s) return '';

  // 1) HH:mm o HH:mm:ss
  {
    const m = s.match(/\b([01]?\d|2[0-3]):([0-5]\d)(?::([0-5]\d))?\b/);
    if (m) return `${String(m[1]).padStart(2,'0')}:${String(m[2]).padStart(2,'0')}`;
  }

  // 2) ISO/fecha completa con hora
  {
    const d = dayjs(s);
    if (d.isValid()) return d.format('HH:mm');
  }

  // 3) Números (Excel):
  //    - 0 <= n < 1  => fracción de día (solo hora)
  //    - n >= 1      => serial fecha+hora (usar fracción)
  {
    const n = Number(s);
    if (Number.isFinite(n)) {
      if (n >= 0 && n < 1) {
        return toHHMM(n * 24 * 60);
      }
      if (n >= 1) {
        const frac = n - Math.floor(n);
        if (frac > 0) return toHHMM(frac * 24 * 60);
      }
    }
  }

  // 4) Nada fiable
  return '';
}

// Mantén estos alias si los usa el resto del código:
function toISODate(d){ return normalizeDate(d) || null; }
function extractHHmm(v){ return normalizeTime(v) || null; }
function minutosEntre(h1,h2){ if(!h1||!h2) return 0; const [a,b]=h1.split(':').map(Number),[c,d]=h2.split(':').map(Number); return (c*60+d)-(a*60+b); }
function parseBloques(str){ try{return JSON.parse(str||'[]')}catch{return []} }
function horasFromBloques(bloques){
  const mins=bloques.reduce((acc,b)=>acc+Math.max(0,minutosEntre(b.inicio,b.fin)-(Number(b.breakMin)||0)),0);
  return Math.round((mins/60)*100)/100;
}

function horasLegacyAware(r){
  // 1) Si hay bloques válidos -> PRIORIDAD MÁXIMA
  const bloques = parseBloques(r.bloques_horas);
  if (Array.isArray(bloques) && bloques.length) {
    return horasFromBloques(bloques);
  }

  // 2) Si hay fecha/hora inicio/fin -> PRIORIDAD ALTA
  const dI = toISODate(r.fecha_inicio) || toISODate(r.fecha_fin);
  const dF = toISODate(r.fecha_fin)    || toISODate(r.fecha_inicio);
  const hI = extractHHmm(r.hora_inicio);
  const hF = extractHHmm(r.hora_fin);

  if (dI && (hI || hF)) {
    const startHH = hI || '00:00';
    const endHH   = hF || startHH;
    const t1 = dayjs(`${dI}T${startHH}`);
    const t2 = dayjs(`${dF || dI}T${endHH}`);
    const mins = Math.max(0, t2.diff(t1, 'minute'));
    return Math.round((mins/60)*100)/100;
  }

  // 3) ÚLTIMO RECURSO: usar horas_totales del Sheet si viniera precargado
  const legacy = Number(r.horas_totales);
  if (Number.isFinite(legacy) && legacy > 0) return legacy;

  // 4) Nada usable
  return 0;
}


function totalCobrado(r){ return ['mo_monto','refacciones_monto','viaticos_monto','iva_monto'].reduce((a,k)=>a+(Number(r[k])||0),0); }
function isGarantia(r){ return String(r.garantia||'').trim().toLowerCase().startsWith('s'); }
function isInstalacion(r){ return (r.actividad||'').toString().toLowerCase().includes('instal'); }
function getMonthRange(){
  const sel = ($('#fMes')?.value || dayjs().format('YYYY-MM'));
  const start = dayjs(sel + '-01').startOf('month');
  const end = start.endOf('month');
  return { start, end };
}

/* ===== API ===== */
async function apiGet(){
  const r = await fetch(API_URL, { method:'GET' });
  const txt = await r.text();
  if (!r.ok) throw new Error(`GET ${r.status} ${txt.slice(0,200)}`);
  return JSON.parse(txt);
}
async function apiPost(op, payload){
  const r = await fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ op, token: EDIT_TOKEN, ...(payload||{}) })
  });
  const txt = await r.text();
  if (!r.ok) throw new Error(txt||'API error');
  return JSON.parse(txt);
}

/* ===== Derivados y filtros ===== */
function deriveComputedFields(rows){
  rows.forEach(r=>{
    r.horas_totales = horasLegacyAware(r);
    r.potencial_garantia = isGarantia(r) ? Math.round(r.horas_totales * TARIFA_GARANTIA) : 0;
    r.total_cobrado = totalCobrado(r);
  });
  return rows;
}
function applyFilters(){
  const a   = ($('#fAsesor')?.value||'').trim().toLowerCase();
  const act = ($('#fActividad')?.value||'').trim().toLowerCase();
  const mod = ($('#fModalidad')?.value||'').trim().toLowerCase();
  const c   = ($('#fCiudad')?.value||'').trim().toLowerCase();
  const rng = ($('#fRango')?.value||'').trim();
  const { start, end } = getMonthRange();

  let out = ROWS.filter(x=>{
    const f = toISODate(x.fecha_inicio) || toISODate(x.fecha_fin);
    if (!f) return false;
    const t = dayjs(f, 'YYYY-MM-DD', true);
    return t.isValid() && t.isBetween(start, end, 'day', '[]');
  });

  if (a)   out = out.filter(x => (x.asesor||'').toString().toLowerCase().includes(a));
  if (act) out = out.filter(x => (x.actividad||'').toString().toLowerCase() === act);
  if (mod) out = out.filter(x => (x.modalidad||'').toString().toLowerCase() === mod);
  if (c)   out = out.filter(x => (x.ciudad||'').toString().toLowerCase().includes(c));

  if (rng && rng.includes('a')) {
    const [d1,d2] = rng.split('a').map(s=>s.trim());
    if (d1 && d2) {
      const t1=dayjs(d1,'YYYY-MM-DD'), t2=dayjs(d2,'YYYY-MM-DD').endOf('day');
      out = out.filter(x=>{
        const f = toISODate(x.fecha_inicio) || toISODate(x.fecha_fin);
        if (!f) return false;
        const t = dayjs(f,'YYYY-MM-DD',true);
        return t.isValid() ? (t.isAfter(t1.subtract(1,'day')) && t.isBefore(t2.add(1,'second'))) : false;
      });
    }
  }
  FILTERED = out;
}

/* ===== KPIs ===== */
function renderKpis(){
  const isSoporte = r => (r.actividad||'').toLowerCase().includes('soporte');
  const isInst    = r => (r.actividad||'').toLowerCase().includes('instal');
  const isEvento  = r => /(evento|proy|curso)/i.test(r.actividad||'');

  $('#kpiC_total').textContent    = FILTERED.length;
  $('#kpiC_soporte').textContent  = FILTERED.filter(isSoporte).length;
  $('#kpiC_inst').textContent     = FILTERED.filter(isInst).length;
  $('#kpiC_eventos').textContent  = FILTERED.filter(isEvento).length;

  const sumPotGar = FILTERED.reduce((a,r)=> a + (Number(r.potencial_garantia)||0), 0);
  $('#kpiPotGarantia').textContent = fmtMoney(sumPotGar);
  const sumMo  = FILTERED.reduce((a,r)=> a + (Number(r.mo_monto)||0), 0);
  const sumRef = FILTERED.reduce((a,r)=> a + (Number(r.refacciones_monto)||0), 0);
  const sumVia = FILTERED.reduce((a,r)=> a + (Number(r.viaticos_monto)||0), 0);
  const sumIva = FILTERED.reduce((a,r)=> a + (Number(r.iva_monto)||0), 0);
  const sumCob = sumMo+sumRef+sumVia+sumIva;
  $('#kpiMo').textContent  = fmtMoney(sumMo);
  $('#kpiRef').textContent = fmtMoney(sumRef);
  $('#kpiVia').textContent = fmtMoney(sumVia);
  $('#kpiIva').textContent = fmtMoney(sumIva);
  $('#kpiCobradoTotal').textContent = fmtMoney(sumCob);

  const rowsInst = FILTERED.filter(isInstalacion);
  const eqSub = rowsInst.reduce((a,r)=> a + (Number(r.equipos_valor_subtotal)||0), 0);
  const eqTot = rowsInst.reduce((a,r)=> a + (Number(r.equipos_valor_total)||0), 0);
  const sumCostoInst = rowsInst.reduce((a,r)=> (Number(r.horas_totales)||0)*TARIFA_INTERNA_INST + (Number(r.viaticos_monto)||0), 0);
  $('#kpiInstCosto').textContent  = fmtMoney(sumCostoInst);
  (document.getElementById('kpiEqSub')||{}).textContent = fmtMoney(eqSub);
  (document.getElementById('kpiEqTot')||{}).textContent = fmtMoney(eqTot);
}

/* ===== Tabla ===== */
function fmtFechaHora(fecha, hora) {
  const f = normalizeDate(fecha);
  const h = normalizeTime(hora);
  if (f && h) return `${f} ${h}`;
  if (f) return f;
  if (h) return h;
  return '—';
}
function renderTable(){
  const tbody = $('#tbody'); tbody.innerHTML = '';
  FILTERED.forEach(r=>{
    const costoInst = isInstalacion(r) ? ((Number(r.horas_totales)||0)*TARIFA_INTERNA_INST + (Number(r.viaticos_monto)||0)) : 0;
    const tr = document.createElement('tr');
    tr.className = 'border-t border-white/10';
    tr.innerHTML = `
      <td class="py-2 px-3">${r.id||''}</td>
      <td class="py-2 px-3">${fmtFechaHora(r.fecha_inicio, r.hora_inicio)}</td>
      <td class="py-2 px-3">${fmtFechaHora(r.fecha_fin,   r.hora_fin)}</td>
      <td class="py-2 px-3">${r.asesor||''}</td>
      <td class="py-2 px-3">
        ${r.actividad||''}
        ${isGarantia(r) ? '<span class="chip chip-warn ml-1">Garantía</span>' : ''}
        ${isInstalacion(r) ? '<span class="chip chip-ok ml-1">Instalación</span>' : ''}
      </td>
      <td class="py-2 px-3">${r.modalidad||''}</td>
      <td class="py-2 px-3 col-horas">${(Number(r.horas_totales)||0).toFixed(2)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.potencial_garantia||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.mo_monto||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.refacciones_monto||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.viaticos_monto||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.iva_monto||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.total_cobrado||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.equipos_valor_subtotal||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.equipos_valor_total||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(costoInst)}</td>
      <td class="py-2 px-3">${r.ciudad||''}</td>
      <td class="py-2 px-3 col-notas whitespace-pre-wrap">${r.notas||''}</td>
      <td class="py-2 px-3 col-acciones">
        <button class="btn" data-edit="${r.id}">✏️ Editar</button>
        <button class="btn" data-del="${r.id}">🗑️ Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.onclick = async (ev)=>{
    const b = ev.target.closest('button');
    if (!b) return;
    const id = b.dataset.edit || b.dataset.del;
    if (!id) return;

    if (b.dataset.del){
      if (!confirm(`¿Eliminar registro #${id}?`)) return;
      try{ await apiPost('delete', { id: Number(id) }); await boot(); }
      catch(e){ alert('Error al eliminar: ' + e.message); }
      return;
    }

    if (b.dataset.edit){
      startEdit(Number(id));
    }
  };
}

/* ===== Mapa ===== */
window.renderMapMarkers = function(){
  if (!window.MAP) return;
  if (window._MAP_MARKERS) window._MAP_MARKERS.forEach(m=>m.setMap && m.setMap(null));
  window._MAP_MARKERS = [];
  (FILTERED||[]).forEach(r=>{
    const lat = parseFloat(r.lat), lng = parseFloat(r.lng);
    if (!isFinite(lat) || !isFinite(lng)) return;
    const marker = addMapMarker(window.MAP, lat, lng, `${r.cliente||''} · ${r.ciudad||''}`);
    window._MAP_MARKERS.push(marker);
  });
};

/* ===== Calendario + modal ===== */
function openModal(evt, row){
  $('#mTitulo').textContent = evt.title || 'Detalle';
  $('#mBody').textContent = [
    `Inicio: ${evt.start?.toISOString?.()||evt.startStr||''}`,
    `Fin: ${evt.end?.toISOString?.()||evt.endStr||''}`,
    `Asesor: ${row?.asesor||''}`,
    `Actividad: ${row?.actividad||''}`,
    `Ciudad: ${row?.ciudad||''}`,
    `Notas: ${row?.notas||''}`
  ].join('\n');
  CAL_EVENT_CLICKED = row;
  $('#modalBg').style.display = 'flex';
}
function closeModal(){ $('#modalBg').style.display = 'none'; CAL_EVENT_CLICKED=null; }
$('#mClose').onclick = closeModal;
$('#modalBg').onclick = (e)=> { if (e.target.id==='modalBg') closeModal(); };
$('#mEdit').onclick = ()=>{ if (CAL_EVENT_CLICKED) { startEdit(Number(CAL_EVENT_CLICKED.id)); closeModal(); } };
$('#mDel').onclick = async ()=>{
  if (!CAL_EVENT_CLICKED) return;
  if (!confirm(`¿Eliminar registro #${CAL_EVENT_CLICKED.id}?`)) return;
  try{ await apiPost('delete', { id: Number(CAL_EVENT_CLICKED.id) }); closeModal(); await boot(); }
  catch(e){ alert('Error al eliminar: ' + e.message); }
};

function renderCalendar(){
  const el = document.getElementById('calendar');
  if (!el) return;
  if (CAL) { CAL.destroy(); CAL = null; }

  const COLOR = {
    'Soporte de garantía': '#22c55e',
    'Soporte fuera de garantía': '#ef4444',
    'Instalación': '#38bdf8',
    'Evento': '#7c3aed',
    'Proyecto': '#f43f5e',
    'Curso': '#eab308',
    'Vacaciones': '#94a3b8'
  };

  const events = [];
  (FILTERED||[]).forEach(r=>{
    const dStart = normalizeDate(r.fecha_inicio) || normalizeDate(r.fecha_fin);
    const dEnd   = normalizeDate(r.fecha_fin)    || normalizeDate(r.fecha_inicio);
    if (!dStart) return;

    const tStart = normalizeTime(r.hora_inicio);
    const tEnd   = normalizeTime(r.hora_fin);
    const act = r.actividad || 'Otro';
    const hasTimes = !!(tStart || tEnd);

    let start = dStart, end;
    if (hasTimes) {
      start = `${dStart}T${tStart || '00:00'}`;
      if (dEnd) end = `${dEnd}T${tEnd || tStart || '00:00'}`;
    } else {
      const endDate = dEnd || dStart;
      end = dayjs(endDate, 'YYYY-MM-DD', true).add(1,'day').format('YYYY-MM-DD'); // allDay
    }

    events.push({
      title: `${act} — ${r.asesor||''}`,
      start, end, allDay: !hasTimes,
      backgroundColor: COLOR[act] || '#60a5fa',
      borderColor: COLOR[act] || '#60a5fa',
      extendedProps: { rjson: r }
    });
  });

  CAL = new FullCalendar.Calendar(el, {
    height: 'auto',
    contentHeight: 900,
    expandRows: true,
    handleWindowResize: true,
    locale: 'es',
    initialView: 'dayGridMonth',
    headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,dayGridDay' },
    events,
    eventClick(info){
      const r = info.event.extendedProps?.rjson || {};
      openModal(info.event, r);
    }
  });
  CAL.render();
}

/* ===== Gráficas ===== */
function renderCharts(){
  // Actividades por asesor
  (function(){
    const c = document.getElementById('chartActAsesor'); if(!c) return;
    const asesores = [...new Set(FILTERED.map(r=>r.asesor||'Sin dato'))];
    const tipos = ['Soporte de garantía','Soporte fuera de garantía','Instalación','Evento','Proyecto','Curso','Vacaciones'];
    const series = tipos.map(t => asesores.map(a => FILTERED.filter(r=> (r.asesor||'Sin dato')===a && (r.actividad||'')===t).length));
    if (CHARTS.chartActAsesor) CHARTS.chartActAsesor.destroy();
    CHARTS.chartActAsesor = new Chart(c,{type:'bar',
      data:{labels:asesores, datasets:tipos.map((t,i)=>({label:t,data:series[i],stack:'stack1'}))},
      options:{responsive:true, maintainAspectRatio:false, scales:{x:{stacked:true}, y:{stacked:true}}}
    });
  })();

  // Remoto vs Presencial
  (function(){
    const c = document.getElementById('chartRemoto'); if(!c) return;
    const rem = FILTERED.filter(r=> (r.modalidad||'').toLowerCase()==='remoto').length;
    const pre = FILTERED.filter(r=> (r.modalidad||'').toLowerCase()==='presencial').length;
    if (CHARTS.chartRemoto) CHARTS.chartRemoto.destroy();
    CHARTS.chartRemoto = new Chart(c,{type:'doughnut',data:{labels:['Remoto','Presencial'],datasets:[{data:[rem,pre]}]},options:{responsive:true,maintainAspectRatio:false}});
  })();

  // Distribución por actividad
  (function(){
    const c = document.getElementById('chartActividad'); if(!c) return;
    const byAct = {}; FILTERED.forEach(r=>{ const k=r.actividad||'Sin dato'; byAct[k]=(byAct[k]||0)+1; });
    if (CHARTS.chartActividad) CHARTS.chartActividad.destroy();
    CHARTS.chartActividad = new Chart(c,{type:'doughnut',data:{labels:Object.keys(byAct),datasets:[{data:Object.values(byAct)}]},options:{responsive:true,maintainAspectRatio:false}});
  })();

  // Garantía vs No
  (function(){
    const c = document.getElementById('chartGarantia'); if(!c) return;
    const si = FILTERED.filter(isGarantia).length; const no = FILTERED.length - si;
    if (CHARTS.chartGarantia) CHARTS.chartGarantia.destroy();
    CHARTS.chartGarantia = new Chart(c,{type:'doughnut',data:{labels:['Garantía','No garantía'],datasets:[{data:[si,no]}]},options:{responsive:true,maintainAspectRatio:false}});
  })();

  // Ingresos por asesor
  (function(){
    const c = document.getElementById('chartIngresos'); if(!c) return;
    const byA={}; FILTERED.forEach(r=>{ const k=r.asesor||'Sin dato'; byA[k]=(byA[k]||0)+(Number(r.total_cobrado)||0); });
    if (CHARTS.chartIngresos) CHARTS.chartIngresos.destroy();
    CHARTS.chartIngresos = new Chart(c,{type:'bar',data:{labels:Object.keys(byA),datasets:[{label:'MXN',data:Object.values(byA)}]},options:{responsive:true,maintainAspectRatio:false}});
  })();
}

/* ===== TeamViewer (totales del mes) ===== */
async function readTVRows(){
  try{
    const txt = await fetch('/connectionreport.csv', { cache:'no-store' }).then(r=>r.ok?r.text():'');
    if (!txt) return { rows:[], totalConn:0, totalHours:0 };
    const lines = txt.trim().split(/\r?\n/).filter(Boolean);
    if (lines.length < 2) return { rows:[], totalConn:0, totalHours:0 };

    const sep = (lines[0].includes(';') && !lines[0].includes(',')) ? ';' : ',';
    const headers = lines[0].split(sep).map(h=>h.trim().replace(/^"|"$/g,''));
    let idxFecha = headers.findIndex(h=>/(date|fecha|start|inicio)/i.test(h)); if (idxFecha===-1) idxFecha=0;
    let idxMin   = headers.findIndex(h=>/(minutes|minutos|duration|duración|time)/i.test(h)); if (idxMin===-1) idxMin=7;

    const { start, end } = getMonthRange();
    const from = start.startOf('day').valueOf();
    const to   = end.endOf('day').valueOf();

    let totalConn = 0, totalMinutes = 0;
    for (const l of lines.slice(1)){
      const cols = l.split(sep).map(c=>c.replace(/^"|"$/g,'').trim());
      const fechaRaw = cols[idxFecha] || cols[0] || '';
      const fISO = toISODate(fechaRaw) || dayjs(fechaRaw,['YYYY-MM-DD','DD/MM/YYYY','MM/DD/YYYY','YYYY/MM/DD']).format('YYYY-MM-DD');
      const t = dayjs(fISO, 'YYYY-MM-DD', true);
      if (!t.isValid()) continue;
      const tv = t.valueOf();
      if (tv < from || tv > to) continue;

      const v = cols[idxMin] || '0';
      let minutes = 0;
      if (/^\d{1,2}:\d{2}(:\d{2})?$/.test(v)) {
        const p = v.split(':').map(Number);
        minutes = (p[0]*60) + (p[1]||0) + (p[2]||0)/60;
      } else {
        const nm = Number(String(v).replace(',','.')); minutes = Number.isFinite(nm) ? nm : 0;
      }
      totalConn += 1;
      totalMinutes += minutes;
    }
    return { rows:[], totalConn, totalHours:(totalMinutes/60) };
  }catch{ return { rows:[], totalConn:0, totalHours:0 }; }
}
async function renderTeamViewerChart(){
  const c = document.getElementById('chartTV'); if (!c) return;
  const { totalConn, totalHours } = await readTVRows();
  if (c._chart) c._chart.destroy();
  c._chart = new Chart(c, {
    type: 'bar',
    data: {
      labels: [dayjs(getMonthRange().start).format('MMMM YYYY')],
      datasets: [
        { type:'bar',  label:'Conexiones', data:[totalConn] },
        { type:'line', label:'Horas',       data:[Number(totalHours.toFixed(2))] }
      ]
    },
    options:{ responsive:true, maintainAspectRatio:false }
  });
}
async function renderTeamViewerTable(){
  const el = document.querySelector('#tvTable tbody'); if (!el) return;
  const { totalConn, totalHours } = await readTVRows();
  const { start } = getMonthRange();
  (document.getElementById('kpiC_tvconn')||{}).textContent = String(totalConn);
  (document.getElementById('kpiC_tvhrs')||{}).textContent  = totalHours.toFixed(2);
  el.innerHTML = `
    <tr class="border-t border-white/10">
      <td class="py-2 px-3">${dayjs(start).format('MMMM YYYY')}</td>
      <td class="py-2 px-3">${totalConn}</td>
      <td class="py-2 px-3">${totalHours.toFixed(2)}</td>
    </tr>`;
}

/* ===== IVA y horas en captura ===== */
function recalcIVA(){
  const f = document.getElementById('frm');
  const mo = Number(f.mo_monto.value||0);
  const ref= Number(f.refacciones_monto.value||0);
  const via= Number(f.viaticos_monto.value||0);
  const iva = (mo+ref+via)*IVA;
  const total = mo+ref+via+iva;
  f.iva_monto.value = Math.round(iva);
  f.total_cobrado.value = Math.round(total);

  const eqSub = Number(f.equipos_valor_subtotal.value||0);
  const eqIVA = eqSub*IVA;
  f.equipos_iva.value = Math.round(eqIVA);
  f.equipos_valor_total.value = Math.round(eqSub + eqIVA);
}
['mo_monto','refacciones_monto','viaticos_monto','equipos_valor_subtotal'].forEach(n=>{
  document.addEventListener('input', (e)=>{ if (e.target?.name===n) recalcIVA(); }, { passive:true });
});

/* ===== Guardar (CREATE) ===== */
document.getElementById('btnGuardar').onclick = async ()=>{
  const f = document.getElementById('frm');
  const data = Object.fromEntries(new FormData(f).entries());
  // calcular horas totales si no hay bloques
  try{
    const bloques = JSON.parse(data.bloques_horas||'[]');
    if (Array.isArray(bloques) && bloques.length){
      data.horas_totales = horasFromBloques(bloques);
    }else if (data.hora_inicio && data.hora_fin){
      const mins = Math.max(0, minutosEntre(data.hora_inicio, data.hora_fin));
      data.horas_totales = Math.round((mins/60)*100)/100;
    }
  }catch{}
  ['mo_monto','refacciones_monto','viaticos_monto','iva_monto','total_cobrado','equipos_valor_subtotal','equipos_iva','equipos_valor_total','horas_totales','lat','lng']
    .forEach(k=> data[k] = Number(data[k]||0));
  try{
    await apiPost('create', { data });
    alert('Guardado');
    f.reset();
    await boot();
  }catch(e){ alert('Error al guardar: '+e.message); }
};
document.getElementById('btnLimpiarForm').onclick = ()=> document.getElementById('frm').reset();

/* ===== Modal de edición (inline usando el mismo form) ===== */
function startEdit(id){
  const r = ROWS.find(x=> Number(x.id)===Number(id));
  if (!r) return alert('Registro no encontrado');
  const f = document.getElementById('frm');
  for (const [k,v] of Object.entries(r)){
    const el = f.querySelector(`[name="${k}"]`);
    if (!el) continue;
    if (k==='fecha_inicio' || k==='fecha_fin'){
      el.value = toISODate(v)||'';
    }else if (k==='hora_inicio' || k==='hora_fin'){
      el.value = extractHHmm(v)||'';
    }else{
      el.value = v==null?'':v;
    }
  }
  f.dataset.editingId = String(id);
  window.scrollTo({ top: f.getBoundingClientRect().top + window.scrollY - 80, behavior:'smooth' });

  const btn = document.getElementById('btnGuardar');
  const oldHandler = btn.onclick;
  btn.textContent = '💾 Actualizar';
  btn.onclick = async ()=>{
    const data = Object.fromEntries(new FormData(f).entries());
    try{
      const bloques = JSON.parse(data.bloques_horas||'[]');
      if (Array.isArray(bloques) && bloques.length){
        data.horas_totales = horasFromBloques(bloques);
      }else if (data.hora_inicio && data.hora_fin){
        const mins = Math.max(0, minutosEntre(data.hora_inicio, data.hora_fin));
        data.horas_totales = Math.round((mins/60)*100)/100;
      }
    }catch{}
    ['mo_monto','refacciones_monto','viaticos_monto','iva_monto','total_cobrado','equipos_valor_subtotal','equipos_iva','equipos_valor_total','horas_totales','lat','lng']
      .forEach(k=> data[k] = Number(data[k]||0));
    try{
      await apiPost('update', { id:Number(f.dataset.editingId), data });
      alert('Actualizado');
      f.reset(); delete f.dataset.editingId;
      btn.textContent = '💾 Guardar'; btn.onclick = oldHandler;
      await boot();
    }catch(e){ alert('Error al actualizar: '+e.message); }
  };
}

/* ===== MODAL FECHA/HORA (UI) ===== */
(() => {
  const bg = document.getElementById('dlgFHbg');
  const picker = document.getElementById('fhPicker');
  const btnIni = document.getElementById('btnFHini');
  const btnFin = document.getElementById('btnFHfin');
  const btnOk = document.getElementById('fhOk');
  const btnCancel = document.getElementById('fhCancel');
  const f = document.getElementById('frm');

  let ctx = 'inicio'; // 'inicio' | 'fin'

  function open(kind){
    ctx = kind;
    const d = f[kind==='inicio'?'fecha_inicio':'fecha_fin'].value || '';
    const h = f[kind==='inicio'?'hora_inicio':'hora_fin'].value || '';
    picker.value = (d && h) ? `${d}T${h}` : '';
    bg.style.display = 'flex';
  }
  function close(){ bg.style.display = 'none'; }

  btnIni.addEventListener('click', ()=>open('inicio'));
  btnFin.addEventListener('click', ()=>open('fin'));
  btnCancel.addEventListener('click', close);
  bg.addEventListener('click', (e)=>{ if (e.target === bg) close(); });

  btnOk.addEventListener('click', ()=>{
    if (!picker.value) { close(); return; }
    const [d, t] = picker.value.split('T');
    const hhmm = (t||'').slice(0,5);
    if (ctx==='inicio'){
      f.fecha_inicio.value = d;
      f.hora_inicio.value  = hhmm;
    }else{
      f.fecha_fin.value = d;
      f.hora_fin.value  = hhmm;
    }
    // si no hay bloques, recalcula rápido
    try{
      const bloques = JSON.parse(f.bloques_horas.value||'[]');
      if (!Array.isArray(bloques) || !bloques.length){
        const mins = Math.max(0, minutosEntre(f.hora_inicio.value, f.hora_fin.value));
        f.horas_totales.value = (Math.round((mins/60)*100)/100) || 0;
      }
    }catch{}
    close();
  });
})();

/* ===== MODAL BLOQUES (UI) ===== */
(() => {
  const bg = document.getElementById('dlgBLbg');
  const btnOpen = document.getElementById('btnBloques');
  const btnOk = document.getElementById('blOk');
  const btnCancel = document.getElementById('blCancel');
  const tbody = document.getElementById('blTbody');
  const lblTotal = document.getElementById('blTotal');

  const inFecha = document.getElementById('blFecha');
  const inIni = document.getElementById('blIni');
  const inFin = document.getElementById('blFin');
  const inBreak = document.getElementById('blBreak');
  const btnAdd = document.getElementById('blAdd');

  const f = document.getElementById('frm');

  let rows = [];

  function open(){
    try{ rows = JSON.parse(f.bloques_horas.value||'[]'); }
    catch{ rows = []; }
    if (!Array.isArray(rows)) rows = [];
    render();
    bg.style.display = 'flex';
  }
  function close(){ bg.style.display = 'none'; }

  function render(){
    tbody.innerHTML = '';
    let totalMin = 0;
    rows.forEach((r, idx)=>{
      const net = Math.max(0, minutosEntre(r.inicio, r.fin) - (Number(r.breakMin)||0));
      totalMin += net;
      const tr = document.createElement('tr');
      tr.className = 'border-t border-white/10';
      tr.innerHTML = `
        <td class="py-2 px-3">${r.fecha||''}</td>
        <td class="py-2 px-3">${r.inicio||''}</td>
        <td class="py-2 px-3">${r.fin||''}</td>
        <td class="py-2 px-3">${r.breakMin||0}</td>
        <td class="py-2 px-3">${net}</td>
        <td class="py-2 px-3"><button class="btn" data-i="${idx}">🗑️</button></td>
      `;
      tbody.appendChild(tr);
    });
    tbody.onclick = (e)=>{
      const b = e.target.closest('button'); if (!b) return;
      const i = Number(b.dataset.i);
      rows.splice(i,1); render();
    };
    lblTotal.textContent = (Math.round((totalMin/60)*100)/100).toFixed(2);
  }

  btnOpen.addEventListener('click', open);
  btnCancel.addEventListener('click', close);
  bg.addEventListener('click', (e)=>{ if (e.target === bg) close(); });

  btnAdd.addEventListener('click', ()=>{
    const r = {
      fecha: inFecha.value || '',
      inicio: inIni.value || '',
      fin: inFin.value || '',
      breakMin: Number(inBreak.value||0)
    };
    if (!r.fecha || !r.inicio || !r.fin) return;
    rows.push(r);
    inIni.value = inFin.value = ''; inBreak.value = '';
    render();
  });

  btnOk.addEventListener('click', ()=>{
    f.bloques_horas.value = JSON.stringify(rows);
    const horas = horasFromBloques(rows);
    f.horas_totales.value = (Math.round(horas*100)/100) || 0;
    close();
  });
})();

/* ===== Render all ===== */
function renderAll(){
  renderKpis();
  renderTable();
  renderCalendar();
  renderCharts();
  renderTeamViewerTable();
  renderTeamViewerChart();
  renderMapMarkers();
}

/* ===== Boot ===== */
async function boot(){
  const sel = $('#fMes'); 
  if (sel && !sel._filled){
    const now = dayjs(); const items=[];
    for(let i=0;i<18;i++){ const d=now.subtract(i,'month'); items.push(`<option value="${d.format('YYYY-MM')}">${d.format('MMMM YYYY')}</option>`); }
    sel.innerHTML = items.join(''); sel._filled=true;
    if (!sel.value) sel.value = dayjs().format('YYYY-MM');
  }
  try{ ROWS = await apiGet(); }catch(e){ console.error(e); alert('Error obteniendo datos'); return; }
  deriveComputedFields(ROWS);
  applyFilters();
  renderAll();
}

/* ===== Eventos UI ===== */
document.getElementById('btnReload').addEventListener('click', boot);
document.getElementById('btnAplicarFiltros').addEventListener('click', ()=>{ applyFilters(); renderAll(); });
document.getElementById('btnLimpiarFiltros').addEventListener('click', ()=>{ 
  $('#fAsesor').value=''; $('#fActividad').value=''; $('#fModalidad').value=''; $('#fCiudad').value=''; $('#fRango').value=''; 
  applyFilters(); renderAll(); 
});
document.getElementById('fMes').addEventListener('change', ()=>{ applyFilters(); renderAll(); });

document.getElementById('btnExportPdf').addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf; const doc = new jsPDF('p','pt','a4');
  const el = document.body; const canvas = await html2canvas(el,{scale:2});
  const imgData = canvas.toDataURL('image/png');
  const pw = doc.internal.pageSize.getWidth(), ph = doc.internal.pageSize.getHeight();
  const ratio = Math.min(pw/canvas.width, ph/canvas.height);
  const iw = canvas.width*ratio, ih = canvas.height*ratio;
  doc.addImage(imgData,'PNG',(pw-iw)/2,10,iw,ih); doc.save('reporte_mdc.pdf');
});

boot();
</script>

<script type="module" src="https://unpkg.com/@googlemaps/extended-component-library@0.6"></script>

<!-- Google Maps + Places -->
<script>
  // Mapa
  window.initMap = function(){
    const center = { lat: 23.6345, lng: -102.5528 };
    window.MAP = new google.maps.Map(document.getElementById('map'), { center, zoom: 5 });
    if (typeof window.renderMapMarkers === 'function') window.renderMapMarkers();
    initAutocomplete();
  };
  // Marcadores (AdvancedMarker si existe)
  window.addMapMarker = function(map, lat, lng, title){
    try {
      const mod = google.maps.marker;
      if (mod && mod.AdvancedMarkerElement) {
        return new mod.AdvancedMarkerElement({ map, position:{lat,lng}, title:title||'' });
      }
    } catch(e){}
    return new google.maps.Marker({ map, position:{lat,lng}, title:title||'' });
  };

  // Autocomplete moderno con fallback
  function initAutocomplete(){
    const boxId = document.getElementById('placeBox');
    if (!boxId) return;

    try{
      const el = document.createElement('gmpx-place-autocomplete');
      el.className = 'formc px-3 py-2 rounded w-full';
      el.placeholder = 'Escribe y selecciona la dirección';
      el.fields = ['formatted_address','address_components','geometry'];
      boxId.appendChild(el);
    }catch(e){
      try{
        const legacy = document.createElement('input');
        legacy.id = 'dirInput';
        legacy.className = 'formc px-3 py-2 rounded w-full';
        legacy.placeholder = 'Escribe y selecciona la dirección';
        boxId.appendChild(legacy);
        const ac = new google.maps.places.Autocomplete(legacy, { fields:['geometry','address_components','formatted_address'] });
        ac.addListener('place_changed', ()=>{
          const p = ac.getPlace();
          if (!p || !p.geometry) return;
          const lat = p.geometry.location.lat();
          const lng = p.geometry.location.lng();
          const city = (p.address_components||[]).find(c=>c.types.includes('locality')||c.types.includes('administrative_area_level_2'));
          const f = document.getElementById('frm');
          if (f){
            f.querySelector('[name=lat]')?.setAttribute('value', lat);
            f.querySelector('[name=lng]')?.setAttribute('value', lng);
            if (city) f.querySelector('[name=ciudad]')?.setAttribute('value', city.long_name);
          }
        });
      }catch(e2){}
    }
  }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1uE6o9Yw9AXq7vxmQiJKPSX08RZvh9N4&libraries=places&loading=async&callback=initMap" async defer></script>
</body>
</html>
