<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MDC — Reporte Mensual de Actividades Asesores CAD-CAM</title>

  <!-- UI libs -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Fechas -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.min.js"></script>
  <script>
    dayjs.extend(window.dayjs_plugin_isoWeek);
    dayjs.extend(window.dayjs_plugin_customParseFormat);
  </script>

  <!-- Gráficas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <!-- Calendario -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/core/locales-all.global.min.js"></script>

 

  <!-- Export PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body{background:#0b0d10;color:#e5e7eb}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);border-radius:1rem}
    .formc{background-color:#1e293b;color:#f1f5f9;border:1px solid #334155}
    .formc::placeholder{color:#cbd5e1}
    select.formc option{color:#000}
    .btn{display:inline-flex;align-items:center;gap:.4rem;border:1px solid rgba(255,255,255,.12);padding:.35rem .6rem;border-radius:.5rem}
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn-danger{border-color:rgba(239,68,68,.5)}
    .btn-danger:hover{background:rgba(239,68,68,.1)}
    .btn-primary{border-color:rgba(59,130,246,.5)}
    .btn-primary:hover{background:rgba(59,130,246,.12)}
    .chip{display:inline-block;padding:.1rem .5rem;border-radius:.375rem;border:1px solid rgba(255,255,255,.15);font-size:.75rem}
    .chip-warn{background:rgba(234,179,8,.12);border-color:rgba(234,179,8,.35)}
    .chip-ok{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}

    /* Tabla y overflow */
    .table-fixed { table-layout: fixed; width: 100%; }
    .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .col-notas { width: 28rem; }
    .col-acciones { width: 10rem; }
    .col-horas { width: 7rem; }
    .col-money { width: 8rem; }
    th, td { overflow-wrap: anywhere; }
    .td-wrap { min-height: 1.5rem; }

    /* Clamp para notas */
    .line-clamp-4 {
      display: -webkit-box;
      -webkit-line-clamp: 4; /* Safari/Chrome */
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-clamp: 4; /* recomendación estándar (experimental) */
    }
    .td-actions { white-space: nowrap; }

    /* Alturas de contenedores */
    #map{min-height:420px;height:420px}
    #calendar{height:820px;}
    .chart-h{height:300px}
    .chart-h-lg{height:320px}

    /* Utilidades */
    .nowrap{white-space:nowrap}
  </style>
  <link rel="stylesheet" href="./styles.css">
  <!-- 1) Define global initMap ANTES de cargar la librería -->
<script>
  // Asegura que initMap exista en window (global) para el callback
  window.initMap = function () {
    const center = { lat: 23.6345, lng: -102.5528 }; // MX
    // Crea el mapa y guárdalo global si el resto del código lo usa
    window.MAP = new google.maps.Map(document.getElementById('map'), {
      center,
      zoom: 5
    });

    // Si ya tienes una función que pinta marcadores, asegúrate de que sea global:
    // window.renderMapMarkers = window.renderMapMarkers || function(){};
    if (typeof window.renderMapMarkers === 'function') {
      window.renderMapMarkers();
    }
  };
</script>

<!-- 2) Carga recomendada: loading=async + async/defer -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1uE6o9Yw9AXq7vxmQiJKPSX08RZvh9N4&libraries=places&loading=async&callback=initMap"
  async
  defer
></script>

</head>
<body class="h-full">
<div class="max-w-7xl mx-auto p-4 sm:p-6">

  <!-- HEADER -->
  <header class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-6">
    <div>
      <h1 class="text-2xl font-semibold">Reporte Mensual de Actividades</h1>
      <p class="text-slate-400 text-sm">MDC Digital · Asesores CAD-CAM</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <button id="btnReload" class="btn">🔄 Recargar</button>
      <button id="btnExportPdf" class="btn">🧾 Exportar PDF</button>
    </div>
  </header>

  <!-- KPIs principales -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Registros</div>
      <div id="kpiTotal" class="text-3xl font-semibold mt-1">0</div>
    </div>
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Potencial no cobrado (garantía)</div>
      <div id="kpiPotGarantia" class="text-3xl font-semibold mt-1">$0</div>
      <div class="text-slate-400 text-xs mt-1">Tarifa $1,000/h</div>
    </div>
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Total cobrado</div>
      <div id="kpiCobradoTotal" class="text-3xl font-semibold mt-1">$0</div>
      <div class="text-slate-400 text-xs mt-1">
        MO: <span id="kpiMo">$0</span> · Ref: <span id="kpiRef">$0</span> · Via: <span id="kpiVia">$0</span> · IVA: <span id="kpiIva">$0</span>
      </div>
    </div>
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Instalaciones — Costo empresa</div>
      <div id="kpiInstCosto" class="text-3xl font-semibold mt-1">$0</div>
      <div class="text-slate-400 text-xs mt-1">85/h + viáticos</div>
    </div>
  </section>

  <!-- KPIs instalaciones detalle -->
  <section class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6">
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Valor equipos instalados (Subtotal)</div>
      <div id="kpiInstValSub" class="text-2xl font-semibold mt-1">$0</div>
    </div>
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Valor equipos instalados (Total c/IVA)</div>
      <div id="kpiInstValTot" class="text-2xl font-semibold mt-1">$0</div>
    </div>
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Ratio Valor / Costo instalación</div>
      <div id="kpiInstRatio" class="text-2xl font-semibold mt-1">—</div>
    </div>
  </section>

  <!-- Filtros -->
  <section class="card p-4 mb-6">
    <h2 class="text-lg font-medium mb-3">Filtros</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
      <select id="fAsesor" class="px-3 py-2 rounded-lg formc">
        <option value="">Todos los asesores</option>
        <option>Israel</option><option>Selene</option><option>Diego</option><option>Yared</option><option>Gabriel</option>
      </select>
      <select id="fActividad" class="px-3 py-2 rounded-lg formc">
        <option value="">Todas las actividades</option>
        <option>Soporte de garantía</option>
        <option>Soporte fuera de garantía</option>
        <option>Instalación</option>
        <option>Evento</option>
        <option>Proyecto</option>
      </select>
      <select id="fModalidad" class="px-3 py-2 rounded-lg formc">
        <option value="">Todas las modalidades</option>
        <option>Remoto</option>
        <option>Presencial</option>
      </select>
      <input id="fCiudad" class="px-3 py-2 rounded-lg formc" placeholder="Ciudad" />
      <input id="fRango" class="px-3 py-2 rounded-lg formc" placeholder="Rango fechas (YYYY-MM-DD a YYYY-MM-DD)" />
    </div>
    <div class="mt-3 flex gap-2">
      <button id="btnAplicarFiltros" class="btn btn-primary">Aplicar filtros</button>
      <button id="btnLimpiarFiltros" class="btn">Limpiar</button>
    </div>
  </section>

  <!-- Panel Map + Calendar + Charts -->
  <section class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-6">
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-medium">Mapa</h3>
        <div class="text-xs text-slate-400">Geolocalización por registro (lat/lng)</div>
      </div>
      <div id="map" class="rounded-lg overflow-hidden"></div>
    </div>

    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-medium">Calendario</h3>
        <div class="text-xs text-slate-400">Eventos por inicio/fin</div>
      </div>
      <div id="calendar" class="rounded-lg bg-slate-900"></div>
    </div>

    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-medium">Distribución por actividad</h3>
      </div>
      <canvas id="chartActividad" class="chart-h"></canvas>
    </div>

    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-medium">Horas por asesor (mes)</h3>
      </div>
      <canvas id="chartHorasAsesor" class="chart-h"></canvas>
    </div>
  </section>

  <!-- Tabla Registros -->
  <section class="card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-medium">Registros</h2>
      <div class="flex gap-2">
        <button id="btnNuevo" class="btn btn-primary">➕ Nuevo</button>
      </div>
    </div>
    <div class="table-container">
      <table id="tbl" class="table-fixed w-full">
        <thead>
          <tr class="text-left text-slate-400">
            <th class="py-2 px-3">ID</th>
            <th class="py-2 px-3">Inicio</th>
            <th class="py-2 px-3">Fin</th>
            <th class="py-2 px-3">Asesor</th>
            <th class="py-2 px-3">Actividad</th>
            <th class="py-2 px-3">Modalidad</th>
            <th class="py-2 px-3 col-horas">Horas</th>
            <th class="py-2 px-3 col-money">Pot. Garantía</th>
            <th class="py-2 px-3 col-money">MO $</th>
            <th class="py-2 px-3 col-money">Ref $</th>
            <th class="py-2 px-3 col-money">Viáticos $</th>
            <th class="py-2 px-3 col-money">IVA $</th>
            <th class="py-2 px-3 col-money">Total $</th>
            <th class="py-2 px-3 col-money">Eq. Subtotal</th>
            <th class="py-2 px-3 col-money">Eq. Total</th>
            <th class="py-2 px-3 col-money">Costo Inst.</th>
            <th class="py-2 px-3">Ciudad</th>
            <th class="py-2 px-3 col-notas">Notas</th>
            <th class="py-2 px-3 col-acciones">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</div>

<!-- MODAL: Nuevo/Editar registro (ligero, puedes ampliar) -->
<div id="modalEdit" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-30">
  <div class="card w-full max-w-3xl p-4">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold" id="editTitle">Nuevo registro</h3>
      <button class="btn" onclick="closeEdit()">✖</button>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div>
        <label class="text-xs text-slate-400">Fecha inicio</label>
        <input id="eFechaIni" type="date" class="formc px-3 py-2 w-full" />
      </div>
      <div>
        <label class="text-xs text-slate-400">Hora inicio</label>
        <input id="eHoraIni" type="time" class="formc px-3 py-2 w-full" />
      </div>
      <div>
        <label class="text-xs text-slate-400">Fecha fin</label>
        <input id="eFechaFin" type="date" class="formc px-3 py-2 w-full" />
      </div>
      <div>
        <label class="text-xs text-slate-400">Hora fin</label>
        <input id="eHoraFin" type="time" class="formc px-3 py-2 w-full" />
      </div>

      <div>
        <label class="text-xs text-slate-400">Asesor</label>
        <input id="eAsesor" class="formc px-3 py-2 w-full" placeholder="Israel / Selene / …" />
      </div>
      <div>
        <label class="text-xs text-slate-400">Actividad</label>
        <select id="eActividad" class="formc px-3 py-2 w-full">
          <option>Soporte de garantía</option>
          <option>Soporte fuera de garantía</option>
          <option>Instalación</option>
          <option>Evento</option>
          <option>Proyecto</option>
        </select>
      </div>
      <div>
        <label class="text-xs text-slate-400">Modalidad</label>
        <select id="eModalidad" class="formc px-3 py-2 w-full">
          <option>Presencial</option>
          <option>Remoto</option>
        </select>
      </div>
      <div>
        <label class="text-xs text-slate-400">Garantía</label>
        <select id="eGarantia" class="formc px-3 py-2 w-full">
          <option>Sí</option>
          <option>No</option>
        </select>
      </div>

      <div>
        <label class="text-xs text-slate-400">Cliente</label>
        <input id="eCliente" class="formc px-3 py-2 w-full" />
      </div>
      <div>
        <label class="text-xs text-slate-400">Teléfono</label>
        <input id="eTelefono" class="formc px-3 py-2 w-full" />
      </div>
      <div>
        <label class="text-xs text-slate-400">Ciudad</label>
        <input id="eCiudad" class="formc px-3 py-2 w-full" />
      </div>
      <div>
        <label class="text-xs text-slate-400">Notas</label>
        <textarea id="eNotas" class="formc px-3 py-2 w-full" rows="3"></textarea>
      </div>

      <div>
        <label class="text-xs text-slate-400">Lat</label>
        <input id="eLat" class="formc px-3 py-2 w-full" />
      </div>
      <div>
        <label class="text-xs text-slate-400">Lng</label>
        <input id="eLng" class="formc px-3 py-2 w-full" />
      </div>
    </div>

    <div class="mt-4 flex items-center justify-between">
      <button class="btn" onclick="openHorasFromEdit()">⏱️ Editar horas</button>
      <div class="flex gap-2">
        <button class="btn" onclick="closeEdit()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveEdit()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL HORAS -->
<div id="modalHoras" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-40">
  <div class="card w-full max-w-2xl p-4">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">Editar horas del servicio</h3>
      <button class="btn" onclick="closeHoras()">✖</button>
    </div>
    <div class="mb-3">
      <table class="w-full">
        <thead class="text-slate-400 text-sm">
          <tr>
            <th class="text-left py-2">Fecha</th>
            <th class="text-left py-2">Inicio</th>
            <th class="text-left py-2">Fin</th>
            <th class="text-left py-2">Break (min)</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="horasRows"></tbody>
      </table>
      <button class="btn mt-2" onclick="addBloqueRow()">➕ Agregar bloque</button>
    </div>
    <div class="flex items-center justify-between">
      <div>Horas totales: <span id="horasTotSpan" class="font-semibold">0</span></div>
      <div class="flex gap-2">
        <button class="btn" onclick="closeHoras()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveHoras()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const API_URL = 'https://script.google.com/macros/s/AKfycbwb_c6_M6S_dKzy4ZxZzudw3LcIjj5gD0XdahCfeH6Vcp5r8GXRoifnvioU7Du48R81/exec'; // e.g. https://script.google.com/macros/s/AKfycbx.../exec
const EDIT_TOKEN = '42673';
const TARIFA_GARANTIA = 1000; // $/hora
const TARIFA_INTERNA_INST = 85; // $/hora

/* ===================== STATE ===================== */
let ROWS = [];           // datos crudos del backend
let FILTERED = [];       // después de aplicar filtros
let ROW_EDIT = null;     // objeto en edición (modal Edit)
let ROW_EDIT_HORAS = null; // referencia para horas (puede venir de tabla o de modal Edit)
let MAP = null;
let MAP_MARKERS = [];
let CHART_ACT = null;
let CHART_HORAS = null;
let CAL = null;

/* ===================== UTILS ===================== */
const $ = (q) => document.querySelector(q);
function fmtMoney(n){ n = Number(n)||0; return n.toLocaleString('es-MX', {style:'currency', currency:'MXN', maximumFractionDigits:0}); }
function minutosEntre(hhmm1, hhmm2){
  if(!hhmm1 || !hhmm2) return 0;
  const [h1,m1] = String(hhmm1).split(':').map(Number);
  const [h2,m2] = String(hhmm2).split(':').map(Number);
  return (h2*60+m2) - (h1*60+m1);
}
function parseBloques(str){ try{return JSON.parse(str||'[]')}catch{return []} }
function horasTotalesFromBloques(bloques){
  const mins = bloques.reduce((acc,b)=>{
    const br = Number(b.breakMin)||0;
    const d = Math.max(0, minutosEntre(b.inicio,b.fin) - br);
    return acc + d;
  },0);
  return Math.round((mins/60)*100)/100;
}
function totalCobrado(r){
  const mo  = Number(r.mo_monto)||0;
  const ref = Number(r.refacciones_monto)||0;
  const via = Number(r.viaticos_monto)||0;
  const iva = Number(r.iva_monto)||0;
  return mo+ref+via+iva;
}
function isGarantia(r){
  const g = (r.garantia||'').toString().trim().toLowerCase();
  return g.startsWith('s'); // Sí
}
function isInstalacion(r){
  return (r.actividad||'').toString().toLowerCase().includes('instal');
}

/* ===================== API ===================== */
async function apiGet(){
  const r = await fetch(API_URL);
  if(!r.ok) throw new Error('GET failed');
  return await r.json();
}
async function apiUpdate(id, data){
  const r = await fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ op:'update', token:EDIT_TOKEN, id, data })
  });
  if(!r.ok){ console.error(await r.text()); throw new Error('POST update failed'); }
  return await r.json();
}
async function apiCreate(data){
  const r = await fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ op:'create', token:EDIT_TOKEN, data })
  });
  if(!r.ok){ console.error(await r.text()); throw new Error('POST create failed'); }
  return await r.json();
}

/* ===================== RENDER – PIPELINE ===================== */
function deriveComputedFields(rows){
  rows.forEach(r=>{
    const bloques = parseBloques(r.bloques_horas);
    const h = horasTotalesFromBloques(bloques);
    r.horas_totales = Number(h || r.horas_totales || 0);
    r.potencial_garantia = isGarantia(r) ? Math.round(r.horas_totales * TARIFA_GARANTIA) : 0;
    r.total_cobrado = totalCobrado(r);
  });
  return rows;
}
function applyFilters(){
  const a = ($('#fAsesor').value||'').trim().toLowerCase();
  const act = ($('#fActividad').value||'').trim().toLowerCase();
  const mod = ($('#fModalidad').value||'').trim().toLowerCase();
  const c  = ($('#fCiudad').value||'').trim().toLowerCase();
  const rng = ($('#fRango').value||'').trim();

  let out = ROWS.slice();
  if (a) out = out.filter(x => (x.asesor||'').toString().toLowerCase().includes(a));
  if (act) out = out.filter(x => (x.actividad||'').toString().toLowerCase() === act);
  if (mod) out = out.filter(x => (x.modalidad||'').toString().toLowerCase() === mod);
  if (c) out = out.filter(x => (x.ciudad||'').toString().toLowerCase().includes(c));

  if (rng && rng.includes('a')) {
    const [d1,d2] = rng.split('a').map(s=>s.trim());
    if (d1 && d2) {
      const t1 = dayjs(d1, 'YYYY-MM-DD');
      const t2 = dayjs(d2, 'YYYY-MM-DD').endOf('day');
      out = out.filter(x=>{
        const f = String(x.fecha_inicio||x.fecha_fin||'');
        const t = dayjs(f, ['YYYY-MM-DD','DD/MM/YYYY']);
        return t.isValid() ? (t.isAfter(t1.subtract(1,'day')) && t.isBefore(t2.add(1,'second'))) : true;
      });
    }
  }
  FILTERED = out;
}

/* ===================== KPIs ===================== */
function renderKpis(){
  $('#kpiTotal').textContent = FILTERED.length.toString();

  const sumPotGar = FILTERED.reduce((a,r)=> a + (Number(r.potencial_garantia)||0), 0);
  $('#kpiPotGarantia').textContent = fmtMoney(sumPotGar);

  const sumMo  = FILTERED.reduce((a,r)=> a + (Number(r.mo_monto)||0), 0);
  const sumRef = FILTERED.reduce((a,r)=> a + (Number(r.refacciones_monto)||0), 0);
  const sumVia = FILTERED.reduce((a,r)=> a + (Number(r.viaticos_monto)||0), 0);
  const sumIva = FILTERED.reduce((a,r)=> a + (Number(r.iva_monto)||0), 0);
  const sumCob = sumMo+sumRef+sumVia+sumIva;
  $('#kpiMo').textContent  = fmtMoney(sumMo);
  $('#kpiRef').textContent = fmtMoney(sumRef);
  $('#kpiVia').textContent = fmtMoney(sumVia);
  $('#kpiIva').textContent = fmtMoney(sumIva);
  $('#kpiCobradoTotal').textContent = fmtMoney(sumCob);

  const rowsInst = FILTERED.filter(isInstalacion);
  const sumValSub = rowsInst.reduce((a,r)=> a + (Number(r.equipos_valor_subtotal)||0), 0);
  const sumValTot = rowsInst.reduce((a,r)=> a + (Number(r.equipos_valor_total)||0), 0);
  const sumCostoInst = rowsInst.reduce((a,r)=>{
    const h = Number(r.horas_totales)||0;
    const vi = Number(r.viaticos_monto)||0;
    return a + (h*TARIFA_INTERNA_INST) + vi;
  }, 0);
  $('#kpiInstValSub').textContent = fmtMoney(sumValSub);
  $('#kpiInstValTot').textContent = fmtMoney(sumValTot);
  $('#kpiInstCosto').textContent  = fmtMoney(sumCostoInst);
  $('#kpiInstRatio').textContent  = (sumCostoInst>0) ? (sumValSub/sumCostoInst).toFixed(2) : '—';
}

/* ===================== TABLA ===================== */
function renderTable(){
  const tbody = $('#tbody');
  tbody.innerHTML = '';
  FILTERED.forEach(r=>{
    const costoInst = isInstalacion(r) ? ((Number(r.horas_totales)||0)*TARIFA_INTERNA_INST + (Number(r.viaticos_monto)||0)) : 0;
    const tr = document.createElement('tr');
    tr.className = 'border-t border-white/10';
    tr.innerHTML = `
      <td class="py-2 px-3">${r.id||''}</td>
      <td class="py-2 px-3">${[r.fecha_inicio,r.hora_inicio].filter(Boolean).join(' ')}</td>
      <td class="py-2 px-3">${[r.fecha_fin,r.hora_fin].filter(Boolean).join(' ')}</td>
      <td class="py-2 px-3">${r.asesor||''}</td>
      <td class="py-2 px-3">
        ${r.actividad||''}
        ${isGarantia(r) ? '<span class="chip chip-warn ml-1">Garantía</span>' : ''}
        ${isInstalacion(r) ? '<span class="chip chip-ok ml-1">Instalación</span>' : ''}
      </td>
      <td class="py-2 px-3">${r.modalidad||''}</td>
      <td class="py-2 px-3 col-horas">${(Number(r.horas_totales)||0).toFixed(2)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.potencial_garantia||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.mo_monto||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.refacciones_monto||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.viaticos_monto||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.iva_monto||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.total_cobrado||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.equipos_valor_subtotal||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.equipos_valor_total||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(costoInst)}</td>
      <td class="py-2 px-3">${r.ciudad||''}</td>
      <td class="py-2 px-3"><div class="td-wrap line-clamp-4 whitespace-pre-wrap">${r.notas||''}</div></td>
      <td class="py-2 px-3 td-actions">
        <button class="btn btn-primary" title="Horas" onclick='openHoras(${JSON.stringify(r.id)})'>⏱️</button>
        <button class="btn" title="Editar" onclick='openEdit(${JSON.stringify(r.id)})'>✏️</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ===================== MAPA ===================== */
function initMap() {
  window.MAP = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 23.6345, lng: -102.5528 },
    zoom: 5,
  });

  if (typeof renderMapMarkers === "function") {
    renderMapMarkers();
  }
}

// ⬇️ ESTA LÍNEA ASEGURA QUE GOOGLE ENCUENTRE initMap
window.initMap = initMap;
function clearMarkers(){
  MAP_MARKERS.forEach(m=>m.setMap(null));
  MAP_MARKERS = [];
}
function renderMapMarkers(){
  if(!MAP) return;
  clearMarkers();
  FILTERED.forEach(r=>{
    const lat = Number(r.lat); const lng = Number(r.lng);
    if(!isFinite(lat) || !isFinite(lng)) return;
    const marker = new google.maps.Marker({
      position:{lat,lng}, map:MAP, title: `${r.cliente||''} · ${r.ciudad||''}`
    });
    const info = new google.maps.InfoWindow({
      content: `
        <div style="min-width:220px">
          <div><strong>${r.cliente||''}</strong></div>
          <div>${r.ciudad||''}</div>
          <div>${(r.actividad||'')}</div>
          <div>Horas: ${(Number(r.horas_totales)||0).toFixed(2)}</div>
        </div>`
    });
    marker.addListener('click', ()=> info.open({anchor: marker, map: MAP}));
    MAP_MARKERS.push(marker);
  });
}
// ⬇️ ESTA LÍNEA LO HACE GLOBAL
window.renderMapMarkers = renderMapMarkers;

/* ===================== CALENDARIO ===================== */
function renderCalendar(){
  const el = document.getElementById('calendar');
  if (CAL) { CAL.destroy(); CAL = null; }
  CAL = new FullCalendar.Calendar(el, {
    height: '100%',
    themeSystem: 'standard',
    locale: 'es',
    initialView: 'dayGridMonth',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,listWeek'
    },
    events: FILTERED.map(r=>{
      const start = (r.fecha_inicio ? `${r.fecha_inicio}T${(r.hora_inicio||'00:00')}` : null);
      const end   = (r.fecha_fin   ? `${r.fecha_fin}T${(r.hora_fin||'00:00')}`   : null);
      return {
        title: `${r.actividad||''} — ${r.asesor||''}`,
        start, end,
        extendedProps: { id: r.id }
      };
    }),
    eventClick: function(info){
      const id = info.event.extendedProps?.id;
      if (id != null) openEdit(id);
    }
  });
  CAL.render();
}

/* ===================== CHARTS ===================== */
function renderCharts(){
  // Actividad
  const ctx1 = document.getElementById('chartActividad');
  if (CHART_ACT) { CHART_ACT.destroy(); CHART_ACT = null; }
  const byAct = {};
  FILTERED.forEach(r=>{
    const k = (r.actividad||'Sin dato');
    byAct[k] = (byAct[k]||0) + 1;
  });
  CHART_ACT = new Chart(ctx1, {
    type:'bar',
    data:{
      labels: Object.keys(byAct),
      datasets:[{ label:'Registros', data:Object.values(byAct) }]
    },
    options:{ responsive:true, maintainAspectRatio:false }
  });

  // Horas por asesor
  const ctx2 = document.getElementById('chartHorasAsesor');
  if (CHART_HORAS) { CHART_HORAS.destroy(); CHART_HORAS = null; }
  const byAsesor = {};
  FILTERED.forEach(r=>{
    const k = (r.asesor||'Sin dato');
    byAsesor[k] = (byAsesor[k]||0) + (Number(r.horas_totales)||0);
  });
  CHART_HORAS = new Chart(ctx2, {
    type:'line',
    data:{
      labels: Object.keys(byAsesor),
      datasets:[{ label:'Horas', data:Object.values(byAsesor), tension:.3 }]
    },
    options:{ responsive:true, maintainAspectRatio:false }
  });
}

/* ===================== MODAL EDIT ===================== */
function openEdit(id){
  const isNew = (id==null);
  $('#editTitle').textContent = isNew ? 'Nuevo registro' : 'Editar registro';
  const r = isNew ? {} : ROWS.find(x=> String(x.id)===String(id));
  ROW_EDIT = r || {};
  // set values
  $('#eFechaIni').value = r?.fecha_inicio||'';
  $('#eHoraIni').value  = r?.hora_inicio||'';
  $('#eFechaFin').value = r?.fecha_fin||'';
  $('#eHoraFin').value  = r?.hora_fin||'';
  $('#eAsesor').value   = r?.asesor||'';
  $('#eActividad').value= r?.actividad||'Soporte de garantía';
  $('#eModalidad').value= r?.modalidad||'Presencial';
  $('#eGarantia').value = r?.garantia||'No';
  $('#eCliente').value  = r?.cliente||'';
  $('#eTelefono').value = r?.telefono||'';
  $('#eCiudad').value   = r?.ciudad||'';
  $('#eNotas').value    = r?.notas||'';
  $('#eLat').value      = r?.lat||'';
  $('#eLng').value      = r?.lng||'';
  // show
  $('#modalEdit').classList.remove('hidden');
  $('#modalEdit').classList.add('flex');
}
function closeEdit(){
  $('#modalEdit').classList.add('hidden');
  $('#modalEdit').classList.remove('flex');
  ROW_EDIT = null;
}
async function saveEdit(){
  const data = {
    fecha_inicio: $('#eFechaIni').value,
    hora_inicio:  $('#eHoraIni').value,
    fecha_fin:    $('#eFechaFin').value,
    hora_fin:     $('#eHoraFin').value,
    asesor:       $('#eAsesor').value,
    actividad:    $('#eActividad').value,
    modalidad:    $('#eModalidad').value,
    garantia:     $('#eGarantia').value,
    cliente:      $('#eCliente').value,
    telefono:     $('#eTelefono').value,
    ciudad:       $('#eCiudad').value,
    notas:        $('#eNotas').value,
    lat:          $('#eLat').value,
    lng:          $('#eLng').value
  };

  if (ROW_EDIT?.id != null){
    await apiUpdate(ROW_EDIT.id, data);
  } else {
    const res = await apiCreate(data);
    if (res?.id) data.id = res.id;
  }
  closeEdit();
  await boot(); // recarga todo
}

/* ===================== HORAS – MODAL ===================== */
function openHoras(id){
  ROW_EDIT_HORAS = ROWS.find(x=> String(x.id)===String(id));
  openHorasModalWithRow(ROW_EDIT_HORAS);
}
function openHorasFromEdit(){
  // desde el modal de edición (nuevo registro sin ID todavía)
  const temp = Object.assign({}, ROW_EDIT || {});
  if (!temp.bloques_horas) temp.bloques_horas = '[]';
  openHorasModalWithRow(temp, true);
}
function openHorasModalWithRow(row, fromEdit=false){
  const cont = $('#horasRows');
  cont.innerHTML = '';
  const arr = parseBloques(row.bloques_horas);
  if(arr.length===0){ arr.push({fecha:row.fecha_inicio||'',inicio:row.hora_inicio||'',fin:row.hora_fin||'',breakMin:0}); }
  arr.forEach(b=>addBloqueRow(b));
  recalcHorasModal();
  $('#modalHoras').classList.remove('hidden');
  $('#modalHoras').classList.add('flex');
  // marca si venimos de modal Edit
  ROW_EDIT_HORAS = Object.assign({ _fromEdit: fromEdit, id: row.id }, row);
}
function closeHoras(){
  $('#modalHoras').classList.add('hidden');
  $('#modalHoras').classList.remove('flex');
  ROW_EDIT_HORAS = null;
}
function addBloqueRow(data){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="py-1 pr-2"><input type="date" class="formc px-2 py-1 w-full" value="${data?.fecha||''}"></td>
    <td class="py-1 pr-2"><input type="time" class="formc px-2 py-1 w-full" value="${data?.inicio||''}"></td>
    <td class="py-1 pr-2"><input type="time" class="formc px-2 py-1 w-full" value="${data?.fin||''}"></td>
    <td class="py-1 pr-2"><input type="number" min="0" class="formc px-2 py-1 w-24" value="${data?.breakMin||0}"></td>
    <td class="py-1"><button class="btn btn-danger" onclick="this.closest('tr').remove(); recalcHorasModal();">🗑️</button></td>
  `;
  $('#horasRows').appendChild(tr);
  [...tr.querySelectorAll('input')].forEach(el=>el.addEventListener('input', recalcHorasModal));
}
function collectBloquesDesdeUI(){
  const rows = [...document.querySelectorAll('#horasRows tr')];
  return rows.map(tr=>{
    const [f,i,fn,b] = tr.querySelectorAll('input');
    return { fecha:f.value, inicio:i.value, fin:fn.value, breakMin:Number(b.value||0) };
  }).filter(x=>x.inicio && x.fin);
}
function recalcHorasModal(){
  const bloques = collectBloquesDesdeUI();
  $('#horasTotSpan').textContent = horasTotalesFromBloques(bloques).toFixed(2);
}
async function saveHoras(){
  const bloques = collectBloquesDesdeUI();
  const horas = horasTotalesFromBloques(bloques);
  const data = { bloques_horas: JSON.stringify(bloques), horas_totales: horas };

  // si venimos del modal Edit (registro nuevo sin guardar), solo “inyectamos” en memoria
  if (ROW_EDIT_HORAS?._fromEdit && ROW_EDIT?.id == null){
    ROW_EDIT.bloques_horas = data.bloques_horas;
    ROW_EDIT.horas_totales = horas;
    closeHoras();
    return;
  }

  // si ya existe ID
  await apiUpdate(ROW_EDIT_HORAS.id, data);
  // refresca local mínimo
  const row = ROWS.find(x=> String(x.id)===String(ROW_EDIT_HORAS.id));
  if (row){
    row.bloques_horas = data.bloques_horas;
    row.horas_totales = horas;
  }
  closeHoras();
  renderAll();
}

/* ===================== FILTROS – Eventos ===================== */
$('#btnAplicarFiltros').addEventListener('click', ()=>{
  applyFilters(); renderAll();
});
$('#btnLimpiarFiltros').addEventListener('click', ()=>{
  $('#fAsesor').value = '';
  $('#fActividad').value = '';
  $('#fModalidad').value = '';
  $('#fCiudad').value = '';
  $('#fRango').value = '';
  applyFilters(); renderAll();
});

/* ===================== EXPORT PDF ===================== */
document.getElementById('btnExportPdf').addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'pt', 'a4');
  const el = document.body; // exporta todo; puedes cambiar a un contenedor
  const canvas = await html2canvas(el, { scale: 2 });
  const imgData = canvas.toDataURL('image/png');
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const ratio = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);
  const imgWidth = canvas.width * ratio;
  const imgHeight = canvas.height * ratio;
  doc.addImage(imgData, 'PNG', (pageWidth - imgWidth)/2, 10, imgWidth, imgHeight);
  doc.save('reporte_mdc.pdf');
});

/* ===================== RENDER ALL ===================== */
function renderAll(){
  renderKpis();
  renderTable();
  renderCalendar();
  renderCharts();
  renderMapMarkers();
}

/* ===================== BOOT ===================== */
async function boot(){
  try{
    ROWS = await apiGet();
  }catch(e){
    console.error(e);
    alert('Error obteniendo datos');
    return;
  }
  deriveComputedFields(ROWS);
  applyFilters();
  renderAll();
}
document.getElementById('btnReload').addEventListener('click', boot);

// Inicia
boot();
</script>
</body>
</html>
