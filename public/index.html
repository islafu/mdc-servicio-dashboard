<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MDC — Reporte Mensual de Actividades</title>

  <!-- Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.min.js"></script>
  <script>dayjs.extend(window.dayjs_plugin_isoWeek);dayjs.extend(window.dayjs_plugin_customParseFormat);</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Google Maps -->
  <script>
    const GOOGLE_MAPS_API_KEY = "AIzaSyD1uE6o9Yw9AXq7vxmQiJKPSX08RZvh9N4";
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1uE6o9Yw9AXq7vxmQiJKPSX08RZvh9N4&libraries=places&callback=initMap"></script>

  <style>
    :root{--bg:#0b0d10;--card:#12161b;--text:#e5e7eb;--muted:#9aa4b2;--brand:#ff2a6d}
    body{background:var(--bg);color:var(--text)}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));background-color:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:1rem}
    .dot{display:inline-block;width:10px;height:10px;border-radius:9999px;margin-right:.5rem}
    .nowrap{white-space:nowrap}
    #map{min-height:420px;height:420px}
    /* Mejor contraste de controles */
    .formc{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#f8fafc}
    .formc::placeholder{color:#cbd5e1}
    .formc:focus{outline:2px solid #22c55e;outline-offset:0}
    select.formc option{color:#0b0d10;background:#e5e7eb}
    /* Alturas para charts */
    .chart-h{height:300px}
    .chart-h-lg{height:320px}
  </style>
</head>
<body class="h-full">
<div class="max-w-7xl mx-auto p-4 sm:p-6">
  <!-- HEADER -->
  <header class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-4">
    <div class="flex items-center gap-3">
      <img src="logo-mdc.png" alt="MDC Digital" class="h-10">
      <div>
        <h1 class="text-2xl font-semibold">MDC — Reporte de Actividades</h1>
        <p class="text-sm text-slate-400">Captura · KPIs · Mapas · PDF</p>
      </div>
    </div>
    <div class="flex flex-wrap gap-2 items-center">
      <select id="monthSelect" class="card px-3 py-2 text-sm formc"></select>
      <button id="exportPdfBtn" class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-black font-medium">Exportar PDF</button>
    </div>
  </header>

  <div id="banner" class="hidden card p-3 mb-4 text-sm"></div>

  <!-- KPIs -->
  <section id="kpis" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
    <div class="card p-4"><div class="text-slate-400 text-xs">Total registros</div><div id="kpiTotal" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs"><span class="dot bg-emerald-400"></span>Soporte</div><div id="kpiSoporte" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs"><span class="dot bg-sky-400"></span>Instalaciones</div><div id="kpiInst" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs"><span class="dot bg-amber-400"></span>Eventos/Proy./Cursos</div><div id="kpiEvt" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs"><span class="dot bg-fuchsia-400"></span>Total cobrado</div><div id="kpiCobrado" class="text-3xl font-semibold mt-1">$0</div></div>
  </section>

  <!-- FILTROS -->
  <section class="card p-4 mb-6">
    <h2 class="text-lg font-medium mb-3">Filtros</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
      <select id="fTecnico" class="px-3 py-2 rounded-lg formc">
        <option value="">Todos los técnicos</option><option>Israel</option><option>Selene</option><option>Diego</option><option>Yared</option>
      </select>
      <select id="fActividad" class="px-3 py-2 rounded-lg formc">
        <option value="">Todas las actividades</option>
        <option>Soporte de garantía</option>
        <option>Soporte fuera de garantía</option>
        <option>Instalación</option>
        <option>Evento</option>
        <option>Proyecto</option>
        <option>Curso</option>
        <option>Vacaciones</option>
      </select>
      <select id="fModalidad" class="px-3 py-2 rounded-lg formc">
        <option value="">Remoto/Presencial</option>
        <option>Remoto</option>
        <option>Presencial</option>
      </select>
      <select id="fGarantia" class="px-3 py-2 rounded-lg formc">
        <option value="">Garantía / No</option><option>Sí</option><option>No</option>
      </select>
      <input id="fBusqueda" placeholder="Buscar cliente/ciudad/nota" class="px-3 py-2 rounded-lg formc" />
    </div>
  </section>

  <!-- GRÁFICAS FILA 1: Donas -->
  <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
    <div class="card p-4">
      <h3 class="mb-2">Distribución por actividad</h3>
      <div class="chart-h"><canvas id="chartActividad"></canvas></div>
    </div>
    <div class="card p-4">
      <h3 class="mb-2">Garantía vs No garantía</h3>
      <div class="chart-h"><canvas id="chartGarantia"></canvas></div>
    </div>
    <div class="card p-4">
      <h3 class="mb-2">Modalidad (Remoto vs Presencial)</h3>
      <div class="chart-h"><canvas id="chartModalidad"></canvas></div>
    </div>
  </section>

  <!-- GRÁFICAS FILA 2: Barras -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
    <div class="card p-4">
      <h3 class="mb-2">Actividades por técnico</h3>
      <div class="chart-h-lg"><canvas id="chartTechCount"></canvas></div>
    </div>
    <div class="card p-4">
      <h3 class="mb-2">Ingresos por técnico (MXN)</h3>
      <div class="chart-h-lg"><canvas id="chartRevenue"></canvas></div>
    </div>
  </section>

  <!-- MAPA -->
  <section class="card p-4 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h3>Mapa de cobertura</h3>
      <div class="text-xs text-slate-400">Tip: escribe dirección, usa tu GPS o haz clic en el mapa.</div>
    </div>
    <div id="map" class="w-full rounded-xl"></div>
  </section>

  <!-- TABLA Y FORM -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-16">
    <!-- Tabla -->
    <div class="card p-4 overflow-visible">
      <div class="flex items-center justify-between mb-2">
        <h3>Registros</h3>
        <button id="btnExportCSV" class="text-xs px-3 py-1 rounded-lg border border-white/10 hover:bg-white/5">Descargar CSV</button>
      </div>
      <table class="w-full text-sm table-auto border-collapse">
        <thead>
          <tr class="text-left text-slate-400">
            <th class="py-2 px-3">Inicio</th>
            <th class="py-2 px-3">Fin</th>
            <th class="py-2 px-3">Técnico</th>
            <th class="py-2 px-3">Actividad</th>
            <th class="py-2 px-3">Modalidad</th>
            <th class="py-2 px-3">Garantía</th>
            <th class="py-2 px-3">Cobrado</th>
            <th class="py-2 px-3">Monto</th>
            <th class="py-2 px-3">Cliente</th>
            <th class="py-2 px-3">Teléfono</th>
            <th class="py-2 px-3">Ciudad</th>
            <th class="py-2 px-3">Notas</th>
          </tr>
        </thead>
        <tbody id="tbody" class="divide-y divide-white/10 text-sm"></tbody>
      </table>
    </div>

    <!-- Captura -->
    <div class="card p-4">
      <h3 class="mb-2">Capturar actividad</h3>
      <form id="form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 auto-rows-min">
        <div><label class="text-xs text-slate-400">Inicio — fecha</label><input name="fecha_inicio" type="date" required class="w-full px-3 py-2 rounded-lg formc"/></div>
        <div><label class="text-xs text-slate-400">Inicio — hora</label><input name="hora_inicio" type="time" required class="w-full px-3 py-2 rounded-lg formc"/></div>
        <div><label class="text-xs text-slate-400">Fin — fecha</label><input name="fecha_fin" type="date" required class="w-full px-3 py-2 rounded-lg formc"/></div>
        <div><label class="text-xs text-slate-400">Fin — hora</label><input name="hora_fin" type="time" required class="w-full px-3 py-2 rounded-lg formc"/></div>

        <div>
          <label class="text-xs text-slate-400">Técnico</label>
          <select name="tecnico" required class="w-full px-3 py-2 rounded-lg formc">
            <option>Israel</option><option>Selene</option><option>Diego</option><option>Yared</option>
          </select>
        </div>

        <div>
          <label class="text-xs text-slate-400">Actividad</label>
          <select name="actividad" required class="w-full px-3 py-2 rounded-lg formc">
            <option>Soporte de garantía</option>
            <option>Soporte fuera de garantía</option>
            <option>Instalación</option>
            <option>Evento</option>
            <option>Proyecto</option>
            <option>Curso</option>
            <option>Vacaciones</option>
          </select>
        </div>

        <div>
          <label class="text-xs text-slate-400">Modalidad</label>
          <select name="modalidad" required class="w-full px-3 py-2 rounded-lg formc">
            <option>Remoto</option><option>Presencial</option>
          </select>
        </div>

        <div class="sm:col-span-2">
          <label class="text-xs text-slate-400">Cliente</label>
          <input id="cliente" name="cliente" list="dlClientes" placeholder="Nombre del cliente" class="w-full px-3 py-2 rounded-lg formc"/>
          <datalist id="dlClientes"></datalist>
        </div>
        <div><label class="text-xs text-slate-400">Teléfono</label><input id="telefono" name="telefono" type="tel" placeholder="10 dígitos" class="w-full px-3 py-2 rounded-lg formc"/></div>
        <div>
          <label class="text-xs text-slate-400">Dirección o ciudad</label>
          <input id="direccion" name="ciudad" placeholder="Ej. Av. Vallarta 6500, Zapopan" class="w-full px-3 py-2 rounded-lg formc"/>
          <div class="mt-2 flex gap-2">
            <button type="button" id="btnUbicacion" class="px-3 py-1.5 text-xs rounded-lg formc">📍 Usar mi ubicación</button>
            <span class="text-xs text-slate-400">o haz clic en el mapa para fijar el punto</span>
          </div>
        </div>

        <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div>
            <label class="text-xs text-slate-400">¿Servicio cobrado?</label>
            <select id="cobrado" name="cobrado" class="w-full px-3 py-2 rounded-lg formc">
              <option>No</option><option>Sí</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-400">Monto (MXN)</label>
            <input id="monto" name="monto" type="number" step="0.01" min="0" placeholder="0.00" class="w-full px-3 py-2 rounded-lg formc"/>
          </div>
          <div class="flex items-end">
            <button class="w-full px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-black font-medium" type="submit">Guardar</button>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div><label class="text-xs text-slate-400">Lat</label><input name="lat" id="lat" type="number" step="any" class="w-full px-3 py-2 rounded-lg formc" readonly/></div>
          <div><label class="text-xs text-slate-400">Lng</label><input name="lng" id="lng" type="number" step="any" class="w-full px-3 py-2 rounded-lg formc" readonly/></div>
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-400">Notas</label>
          <textarea name="notas" rows="3" class="w-full px-3 py-2 rounded-lg formc whitespace-normal break-words" placeholder="Descripción breve"></textarea>
        </div>
      </form>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="text-center text-xs text-slate-500 pb-10">© MDC Dental — Sistema de Reporte Mensual · Desarrollado por Israel Landa Fuentes</footer>
</div>

<script>
/* ========= CONFIG ========= */
const SHEETS_ENDPOINT = "/.netlify/functions/sheets";

/* ========= DEMO ========= */
const demoData = [
  {fecha_inicio:"2025-08-02",hora_inicio:"09:00",fecha_fin:"2025-08-02",hora_fin:"10:15",tecnico:"Israel",actividad:"Soporte de garantía",modalidad:"Remoto",garantia:"Sí",cliente:"Clínica Sonrisa Feliz",telefono:"3312345678",ciudad:"Guadalajara, JAL",notas:"Actualización de software",lat:20.6736,lng:-103.344,cobrado:"Sí",monto:1200},
  {fecha_inicio:"2025-08-03",hora_inicio:"11:30",fecha_fin:"2025-08-03",hora_fin:"14:00",tecnico:"Selene",actividad:"Instalación",modalidad:"Presencial",garantia:"",cliente:"Dental Zapopan",telefono:"3323456789",ciudad:"Zapopan, JAL",notas:"Calibración fresadora",lat:20.7236,lng:-103.389,cobrado:"No",monto:0},
  {fecha_inicio:"2025-08-05",hora_inicio:"08:15",fecha_fin:"2025-08-05",hora_fin:"09:00",tecnico:"Diego",actividad:"Proyecto",modalidad:"Remoto",garantia:"",cliente:"Sonrisas del Bajío",telefono:"4771234567",ciudad:"León, GTO",notas:"Integración CAD/CAM",lat:21.1221,lng:-101.68,cobrado:"Sí",monto:800},
  {fecha_inicio:"2025-08-08",hora_inicio:"10:00",fecha_fin:"2025-08-08",hora_fin:"13:00",tecnico:"Yared",actividad:"Curso",modalidad:"Presencial",garantia:"",cliente:"Colegio Odontológico",telefono:"",ciudad:"Torreón, COAH",notas:"Entrenamiento fresadora",lat:25.54,lng:-103.40,cobrado:"Sí",monto:20000}
];

let state = {
  rows: [],
  month: dayjs().format('YYYY-MM'),
  filters: { tecnico:"", actividad:"", modalidad:"", garantia:"", q:"" },
  charts: {},
  clientBook: {},
};

/* ========= UI helpers ========= */
function setBanner(msg,type="info"){const el=document.getElementById('banner');el.classList.remove('hidden');el.innerText=msg;el.className=`card p-3 mb-4 text-sm ${type==='error'?'border-red-500/40 text-red-300':''}`;}
function hideBanner(){document.getElementById('banner').classList.add('hidden');}

/* ========= Month select ========= */
function initMonthSelect(){
  const sel=document.getElementById('monthSelect'); const months=[]; const base=dayjs();
  for(let i=0;i<12;i++) months.push(base.subtract(i,'month').format('YYYY-MM'));
  sel.innerHTML=months.map(m=>`<option value="${m}">${dayjs(m+'-01').format('MMMM YYYY')}</option>`).join('');
  sel.value=state.month; sel.addEventListener('change',e=>{state.month=e.target.value; renderAll();});
}

/* ========= Load/Save ========= */
async function loadData(){
  try{
    const res=await fetch(SHEETS_ENDPOINT);
    if(!res.ok) throw new Error('No se pudo leer el endpoint');
    const data=await res.json();
    const arr=(Array.isArray(data)?data:[]).map(normalizeRowFromSheet);
    state.rows = arr.length? arr : demoData.slice();
    if(!arr.length) setBanner('Tu hoja está vacía. Mostrando datos DEMO.');
  }catch(err){
    console.error(err); state.rows=demoData.slice(); setBanner('No se pudo conectar con el Sheet. Mostrando datos DEMO.','error');
  }
  rebuildClientBook(); populateClientDatalist();
}

function normalizeRowFromSheet(r){
  const rawActividad = r.actividad || r.Actividad || '';
  const rawModalidad = r.modalidad || r.Modalidad || (['Remoto','Presencial'].includes(r.tipo)? r.tipo : '');
  const garantiaDerivada =
    rawActividad==='Soporte de garantía' ? 'Sí' :
    rawActividad==='Soporte fuera de garantía' ? 'No' :
    (r.garantia || r.Garantia || r.Garantía || '');

  return {
    fecha_inicio: r.fecha_inicio || r['fecha inicio'] || r.fecha || '',
    hora_inicio:  r.hora_inicio  || r['hora inicio']  || '',
    fecha_fin:    r.fecha_fin    || r['fecha fin']    || r.fecha || '',
    hora_fin:     r.hora_fin     || r['hora fin']     || '',
    tecnico:      r.tecnico || r.Técnico || r.Tecnico || '',
    actividad:    rawActividad,
    modalidad:    rawModalidad,
    garantia:     garantiaDerivada,
    cliente:      r.cliente || r.Cliente || '',
    telefono:     r.telefono || r.Teléfono || r.Telefono || '',
    ciudad:       r.ciudad || r.Ciudad || '',
    notas:        r.notas || r.Notas || '',
    lat:          r.lat? Number(r.lat): undefined,
    lng:          r.lng? Number(r.lng): undefined,
    cobrado:      r.cobrado || r.Cobrado || 'No',
    monto:        r.monto? Number(r.monto) : 0,
  };
}

async function saveRow(p){
  try{
    const res=await fetch(SHEETS_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
    if(!res.ok) throw new Error('Error al guardar');
    await loadData(); hideBanner(); renderAll();
  }catch(err){console.error(err); setBanner('Error al guardar. Revisa tu Apps Script/endpoint.','error');}
}

/* ========= Client autocomplete ========= */
function loadClientBookLS(){try{const raw=localStorage.getItem('mdc_client_book');return raw?JSON.parse(raw):{};}catch(e){return {};}
}
function saveClientBookLS(){localStorage.setItem('mdc_client_book',JSON.stringify(state.clientBook));}
function upsertClient(nombre,tel){if(!nombre)return; state.clientBook[nombre]=tel||state.clientBook[nombre]||''; saveClientBookLS(); populateClientDatalist();}
function rebuildClientBook(){state.clientBook=loadClientBookLS(); state.rows.forEach(r=>{if(r.cliente){upsertClient(r.cliente,r.telefono)}});}
function populateClientDatalist(){
  const dl=document.getElementById('dlClientes'); const names=Object.keys(state.clientBook).sort();
  dl.innerHTML=names.map(n=>`<option value="${n}"></option>`).join('');
  const clienteInput=document.getElementById('cliente'); const telInput=document.getElementById('telefono');
  clienteInput?.addEventListener('change',()=>{const name=clienteInput.value; if(name&&state.clientBook[name]){telInput.value=state.clientBook[name];}});
}

/* ========= Filters ========= */
function getFiltered(){
  const {tecnico,actividad,modalidad,garantia,q}=state.filters; const [y,m]=state.month.split('-');
  return state.rows.filter(r=>{
    const start=r.fecha_inicio||r.fecha; const inMonth=start&&dayjs(start).format('YYYY-MM')===`${y}-${m}`;
    if(!inMonth) return false;
    if(tecnico && r.tecnico!==tecnico) return false;
    if(actividad && r.actividad!==actividad) return false;
    if(modalidad && r.modalidad!==modalidad) return false;
    if(garantia && r.garantia!==garantia) return false;
    if(q){const s=`${r.cliente||''} ${r.ciudad||''} ${r.notas||''}`.toLowerCase(); if(!s.includes(q.toLowerCase())) return false;}
    return true;
  });
}

/* ========= KPIs / Charts ========= */
function formatMoney(n){try{return n.toLocaleString('es-MX',{style:'currency',currency:'MXN'});}catch(e){return '$'+(n||0).toFixed(2);}}
function renderKPIs(rows){
  const total=rows.length;
  const soporte=rows.filter(r=> r.actividad==='Soporte de garantía' || r.actividad==='Soporte fuera de garantía').length;
  const instal=rows.filter(r=> r.actividad==='Instalación').length;
  const otros =rows.filter(r=> ['Evento','Proyecto','Curso'].includes(r.actividad)).length;
  const cob=rows.reduce((a,r)=>a+(r.cobrado==='Sí'?(Number(r.monto)||0):0),0);
  document.getElementById('kpiTotal').innerText=total;
  document.getElementById('kpiSoporte').innerText=soporte;
  document.getElementById('kpiInst').innerText=instal;
  document.getElementById('kpiEvt').innerText=otros;
  document.getElementById('kpiCobrado').innerText=formatMoney(cob);
}

function ensureChart(id,config){
  const ctx=document.getElementById(id).getContext('2d');
  if(state.charts[id]) state.charts[id].destroy();
  // Para permitir que respete la altura del contenedor:
  config.options = config.options || {};
  config.options.maintainAspectRatio = false;
  config.options.responsive = true;
  state.charts[id]=new Chart(ctx,config);
}

function renderCharts(rows){
  const tecnicos=['Israel','Selene','Diego','Yared'];
  const acts=['Soporte de garantía','Soporte fuera de garantía','Instalación','Evento','Proyecto','Curso','Vacaciones'];

  // Donut Actividad
  ensureChart('chartActividad',{
    type:'doughnut',
    data:{labels:acts,datasets:[{data:acts.map(a=>rows.filter(r=>r.actividad===a).length)}]},
    options:{plugins:{legend:{position:'bottom'}}}
  });

  // Donut Garantía
  const g=rows.filter(r=>r.garantia==='Sí').length, ng=rows.filter(r=>r.garantia==='No').length;
  ensureChart('chartGarantia',{
    type:'doughnut',
    data:{labels:['Garantía','No garantía'],datasets:[{data:[g,ng]}]},
    options:{plugins:{legend:{position:'bottom'}}}
  });

  // Donut Modalidad
  const rem=rows.filter(r=>r.modalidad==='Remoto').length, pre=rows.filter(r=>r.modalidad==='Presencial').length;
  ensureChart('chartModalidad',{
    type:'doughnut',
    data:{labels:['Remoto','Presencial'],datasets:[{data:[rem,pre]}]},
    options:{plugins:{legend:{position:'bottom'}}}
  });

  // Barra Actividades por técnico (total de registros por técnico)
  const techCounts = tecnicos.map(t => rows.filter(r=>r.tecnico===t).length);
  ensureChart('chartTechCount',{
    type:'bar',
    data:{labels:tecnicos,datasets:[{label:'Total actividades',data:techCounts}]},
    options:{
      plugins:{legend:{display:false},tooltip:{callbacks:{label:(c)=>`${c.parsed.y||0} actividades`}}},
      scales:{y:{beginAtZero:true}}
    }
  });

  // Barra Revenue por técnico
  const rev=tecnicos.map(t=>rows.reduce((sum,r)=>sum+(r.tecnico===t&&r.cobrado==='Sí'?(Number(r.monto)||0):0),0));
  ensureChart('chartRevenue',{
    type:'bar',
    data:{labels:tecnicos,datasets:[{label:'MXN',data:rev}]},
    options:{
      plugins:{legend:{display:false},tooltip:{callbacks:{label:(c)=>formatMoney(c.parsed.y)}}},
      scales:{y:{beginAtZero:true,ticks:{callback:(v)=>formatMoney(v)}}}
    }
  });
}

/* ========= Table ========= */
function renderTable(rows){
  const tbody=document.getElementById('tbody');
  const fmt=(d,t)=> d?(t?dayjs(`${d} ${t}`).format('DD/MM/YYYY HH:mm'):dayjs(d).format('DD/MM/YYYY')):'';
  tbody.innerHTML=rows.map(r=>`
    <tr>
      <td class="py-2 px-3 nowrap align-top">${fmt(r.fecha_inicio,r.hora_inicio)}</td>
      <td class="py-2 px-3 nowrap align-top">${fmt(r.fecha_fin,r.hora_fin)}</td>
      <td class="py-2 px-3 align-top">${r.tecnico||''}</td>
      <td class="py-2 px-3 align-top">${r.actividad||''}</td>
      <td class="py-2 px-3 align-top">${r.modalidad||''}</td>
      <td class="py-2 px-3 align-top">${r.garantia||''}</td>
      <td class="py-2 px-3 align-top">${r.cobrado||'No'}</td>
      <td class="py-2 px-3 align-top">${r.cobrado==='Sí'?formatMoney(Number(r.monto)||0):''}</td>
      <td class="py-2 px-3 align-top whitespace-normal break-words">${r.cliente||''}</td>
      <td class="py-2 px-3 align-top whitespace-normal break-words">${r.telefono||''}</td>
      <td class="py-2 px-3 align-top whitespace-normal break-words">${r.ciudad||''}</td>
      <td class="py-2 px-3 align-top whitespace-normal break-words">${r.notas||''}</td>
    </tr>
  `).join('');
}

/* ========= Google Maps ========= */
let gmap=null,gmarkers=[],geocoder=null,placeAutocomplete=null,clickMarker=null;
function ensureGoogleReady(){return new Promise(res=>{if(window.google?.maps)return res(); const iv=setInterval(()=>{if(window.google?.maps){clearInterval(iv);res();}},100);});}
async function initMap(){
  await ensureGoogleReady();
  geocoder=new google.maps.Geocoder();
  gmap=new google.maps.Map(document.getElementById('map'),{center:{lat:22.0,lng:-102.0},zoom:5,mapTypeControl:false,streetViewControl:false});
  gmap.addListener('click',(e)=>{setClickMarker(e.latLng); document.getElementById('lat').value=e.latLng.lat().toFixed(6); document.getElementById('lng').value=e.latLng.lng().toFixed(6);});
  const input=document.getElementById('direccion');
  if(input){
    placeAutocomplete=new google.maps.places.Autocomplete(input,{fields:['geometry']});
    placeAutocomplete.addListener('place_changed',()=>{const place=placeAutocomplete.getPlace(); if(place?.geometry){const pos=place.geometry.location; gmap.setCenter(pos); gmap.setZoom(14); setClickMarker(pos); document.getElementById('lat').value=pos.lat().toFixed(6); document.getElementById('lng').value=pos.lng().toFixed(6);} });
  }
  const btn=document.getElementById('btnUbicacion');
  btn?.addEventListener('click',()=>{ if(!navigator.geolocation){setBanner('Tu dispositivo no permite geolocalización','error');return;}
    navigator.geolocation.getCurrentPosition(p=>{const {latitude,longitude}=p.coords; const pos={lat:latitude,lng:longitude}; gmap.setCenter(pos); gmap.setZoom(15); setClickMarker(pos); document.getElementById('lat').value=latitude.toFixed(6); document.getElementById('lng').value=longitude.toFixed(6);},
      err=>setBanner('No se pudo leer tu ubicación ('+err.message+')','error'));
  });
}
function setClickMarker(latLng){ if(clickMarker) clickMarker.setMap(null); clickMarker=new google.maps.Marker({position:latLng,map:gmap,animation:google.maps.Animation.DROP}); }
function toNum(n){const v=Number(n); return Number.isFinite(v)?v:null;}
function clearMarkers(){gmarkers.forEach(m=>m.setMap(null)); gmarkers=[];}
function renderMarkers(rows){
  if(!gmap) return; clearMarkers();
  const bounds=new google.maps.LatLngBounds(); let any=false;
  rows.forEach(r=>{const lat=toNum(r.lat), lng=toNum(r.lng||r.long); if(lat==null||lng==null) return; const pos={lat,lng};
    const marker=new google.maps.Marker({position:pos,map:gmap,title:`${r.cliente||'Cliente'} — ${r.tecnico||''}`});
    const html=`<div style="min-width:220px"><div><strong>${r.cliente||'Cliente'}</strong></div><div>${r.ciudad||''}</div><div>${r.actividad||''} · ${r.modalidad||''} · Garantía: ${r.garantia||''}</div><div>Por: ${r.tecnico||''}</div><div>${(r.fecha_inicio||'')} ${r.hora_inicio||''}</div>${r.cobrado==='Sí'?`<div><strong>Monto:</strong> ${formatMoney(Number(r.monto)||0)}</div>`:''}</div>`;
    const iw=new google.maps.InfoWindow({content:html}); marker.addListener('click',()=>iw.open({anchor:marker,map:gmap}));
    gmarkers.push(marker); bounds.extend(pos); any=true;});
  if(any){ if(gmarkers.length===1){gmap.setCenter(gmarkers[0].getPosition()); gmap.setZoom(14);} else {gmap.fitBounds(bounds,60);} }
}

/* ========= CSV / PDF ========= */
function exportCSV(rows){
  const header=['fecha_inicio','hora_inicio','fecha_fin','hora_fin','tecnico','actividad','modalidad','garantia','cobrado','monto','cliente','telefono','ciudad','notas','lat','lng'];
  const lines=[header.join(',')].concat(rows.map(r=> header.map(h=>{const v=(r[h]??'').toString().replaceAll('"','""'); return `"${v}"`;}).join(',')));
  const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`mdc-servicio-${state.month}.csv`; a.click(); URL.revokeObjectURL(url);
}
async function exportPDF(){const {jsPDF}=window.jspdf; const node=document.body; const canvas=await html2canvas(node,{scale:2,useCORS:true}); const img=canvas.toDataURL('image/png'); const pdf=new jsPDF('p','mm','a4'); const W=pdf.internal.pageSize.getWidth(); const H=canvas.height*W/canvas.width; let pos=0,left=H; pdf.addImage(img,'PNG',0,pos,W,H); left-=pdf.internal.pageSize.getHeight(); while(left>0){pos=left-H; pdf.addPage(); pdf.addImage(img,'PNG',0,pos,W,H); left-=pdf.internal.pageSize.getHeight();} pdf.save(`MDC-Reporte-${state.month}.pdf`);}

/* ========= Render ========= */
function renderAll(){const rows=getFiltered(); renderKPIs(rows); renderCharts(rows); renderTable(rows); renderMarkers(rows);}

/* ========= Bind ========= */
function bindUI(){
  document.getElementById('fTecnico').addEventListener('change',e=>{state.filters.tecnico=e.target.value; renderAll();});
  document.getElementById('fActividad').addEventListener('change',e=>{state.filters.actividad=e.target.value; renderAll();});
  document.getElementById('fModalidad').addEventListener('change',e=>{state.filters.modalidad=e.target.value; renderAll();});
  document.getElementById('fGarantia').addEventListener('change',e=>{state.filters.garantia=e.target.value; renderAll();});
  document.getElementById('fBusqueda').addEventListener('input',e=>{state.filters.q=e.target.value; renderAll();});
  document.getElementById('btnExportCSV').addEventListener('click',()=>exportCSV(getFiltered()));
  document.getElementById('exportPdfBtn').addEventListener('click',exportPDF);

  const cobSel=document.getElementById('cobrado'), monInp=document.getElementById('monto');
  function toggleMonto(){const yes=cobSel?.value==='Sí'; if(monInp){monInp.disabled=!yes; if(!yes) monInp.value='';}}
  cobSel?.addEventListener('change',toggleMonto); toggleMonto();

  const form=document.getElementById('form');
  form.addEventListener('submit',async (e)=>{e.preventDefault(); const fd=new FormData(form); const p=Object.fromEntries(fd.entries());
    // Derivar garantía desde actividad
    if (p.actividad === 'Soporte de garantía') p.garantia = 'Sí';
    else if (p.actividad === 'Soporte fuera de garantía') p.garantia = 'No';
    else p.garantia = '';

    const start=dayjs(`${p.fecha_inicio} ${p.hora_inicio}`,'YYYY-MM-DD HH:mm'); const end=dayjs(`${p.fecha_fin} ${p.hora_fin}`,'YYYY-MM-DD HH:mm');
    if(!start.isValid()||!end.isValid()||end.isBefore(start)){setBanner('Revisa fechas/horas: el fin no puede ser antes que el inicio.','error'); return;}
    if(p.cobrado==='Sí'){p.monto=p.monto?Number(p.monto):0;} else {p.monto=0;}
    p.lat = document.getElementById('lat').value ? Number(document.getElementById('lat').value) : undefined;
    p.lng = document.getElementById('lng').value ? Number(document.getElementById('lng').value) : undefined;

    upsertClient(p.cliente,p.telefono);
    await saveRow(p); form.reset();
  });
}

/* ========= Init ========= */
(async function(){ lucide.createIcons(); initMonthSelect(); bindUI(); await loadData(); renderAll(); })();
window.initMap = initMap;
</script>
</body>
</html>
