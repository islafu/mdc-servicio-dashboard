<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MDC Digital — Reporte de Actividades Asesores CAD-CAM</title>

  <!-- Tailwind (build) + fallback CDN si falla -->
  <link rel="stylesheet" href="/styles.css">
  <script>
  (function(){
    var probe=document.createElement('div'); probe.className='hidden';
    document.head.appendChild(probe);
    var ok = getComputedStyle(probe).display==='none'; probe.remove();
    if(!ok){ var s=document.createElement('script'); s.src='https://cdn.tailwindcss.com'; document.head.appendChild(s); }
  })();
  </script>

  <!-- FullCalendar CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css">

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.min.js"></script>
  <script>dayjs.extend(window.dayjs_plugin_isoWeek); dayjs.extend(window.dayjs_plugin_customParseFormat);</script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/core/locales-all.global.min.js"></script>

  <!-- Export PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body{background:#0b0d10;color:#e5e7eb}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);border-radius:1rem}
    .formc{background-color:#1e293b;color:#f1f5f9;border:1px solid #334155}
    .formc::placeholder{color:#cbd5e1}
    select.formc option{color:#000}
    .btn{display:inline-flex;align-items:center;gap:.4rem;border:1px solid rgba(255,255,255,.12);padding:.35rem .6rem;border-radius:.5rem}
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn-danger{border-color:rgba(239,68,68,.5)}
    .btn-danger:hover{background:rgba(239,68,68,.1)}
    .btn-primary{border-color:rgba(59,130,246,.5)}
    .btn-primary:hover{background:rgba(59,130,246,.12)}
    .chip{display:inline-block;padding:.1rem .5rem;border-radius:.375rem;border:1px solid rgba(255,255,255,.15);font-size:.75rem}
    .chip-warn{background:rgba(234,179,8,.12);border-color:rgba(234,179,8,.35)}
    .chip-ok{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
    /* Tabla legible */
    .table-viewport { max-height: 65vh; overflow: auto; }
    #tbl { table-layout: fixed; width: 100%; border-collapse: separate; border-spacing: 0; }
    #tbl thead th { position: sticky; top: 0; background: #0f172a; z-index: 1; }
    #tbl th, #tbl td { font-size: 0.9rem; line-height: 1.2; }
    #tbl td { padding-top:.45rem; padding-bottom:.45rem; }
    .col-notas { width: 28rem; }
    .col-acciones { width: 10rem; white-space: nowrap; }
    .col-horas { width: 7rem; }
    .col-money { width: 8rem; white-space: nowrap; }
    th, td { overflow-wrap: anywhere; }
    .td-wrap { min-height: 1.5rem; }
    .line-clamp-4 {
      display: -webkit-box;
      -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; line-clamp: 4;
    }
    /* Gráficas */
    canvas { max-width: 100%; }
    .chart-h { height: 300px; }
    .chart-h-lg { height: 320px; }
    /* Mapa/Calendario */
    #map{min-height:420px;height:420px}
    #calendar{height:820px}
  </style>
</head>
<body class="h-full">
<div class="max-w-7xl mx-auto p-4 sm:p-6">

  <!-- HEADER -->
  <header class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-6">
    <div class="flex items-center gap-3">
      <img src="/logo-mdc.png" alt="MDC Digital" class="h-10 w-auto rounded-sm">
      <div>
        <h1 class="text-2xl font-semibold">MDC Digital — Reporte de Actividades Asesores CAD-CAM</h1>
        <p class="text-slate-400 text-sm">Captura · KPIs · Mapas · Calendario · PDF</p>
      </div>
    </div>
    <div class="flex flex-wrap gap-2">
      <select id="fMes" class="px-3 py-2 rounded-lg formc"></select>
      <button id="btnExportPdf" class="btn bg-emerald-600/80 hover:bg-emerald-600 text-white">🧾 Exportar PDF</button>
    </div>
  </header>

  <!-- KPIs CLÁSICOS -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3 mb-6">
    <div class="card p-4"><div class="text-slate-400 text-xs">Total registros</div><div id="kpiC_total" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs">Soporte</div><div id="kpiC_soporte" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs">Instalaciones</div><div id="kpiC_inst" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs">Eventos/Proy./Cursos</div><div id="kpiC_eventos" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs">Total cobrado</div><div id="kpiC_cobrado" class="text-3xl font-semibold mt-1">$0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs">Horas TeamViewer</div><div id="kpiC_tvhrs" class="text-3xl font-semibold mt-1">0</div></div>
  </section>

  <!-- KPIs NUEVOS -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Registros</div>
      <div id="kpiTotal" class="text-3xl font-semibold mt-1">0</div>
    </div>
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Potencial no cobrado (garantía)</div>
      <div id="kpiPotGarantia" class="text-3xl font-semibold mt-1">$0</div>
      <div class="text-slate-400 text-xs mt-1">Tarifa $1,000/h</div>
    </div>
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Total cobrado</div>
      <div id="kpiCobradoTotal" class="text-3xl font-semibold mt-1">$0</div>
      <div class="text-slate-400 text-xs mt-1">
        MO: <span id="kpiMo">$0</span> · Ref: <span id="kpiRef">$0</span> · Via: <span id="kpiVia">$0</span> · IVA: <span id="kpiIva">$0</span>
      </div>
    </div>
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Instalaciones — Costo empresa</div>
      <div id="kpiInstCosto" class="text-3xl font-semibold mt-1">$0</div>
      <div class="text-slate-400 text-xs mt-1">85/h + viáticos</div>
    </div>
  </section>

  <!-- KPIs instalaciones detalle -->
  <section class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6">
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Valor equipos instalados (Subtotal)</div>
      <div id="kpiInstValSub" class="text-2xl font-semibold mt-1">$0</div>
    </div>
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Valor equipos instalados (Total c/IVA)</div>
      <div id="kpiInstValTot" class="text-2xl font-semibold mt-1">$0</div>
    </div>
    <div class="card p-4">
      <div class="text-slate-400 text-xs">Ratio Valor / Costo instalación</div>
      <div id="kpiInstRatio" class="text-2xl font-semibold mt-1">—</div>
    </div>
  </section>

  <!-- Filtros -->
  <section class="card p-4 mb-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
      <select id="fAsesor" class="px-3 py-2 rounded-lg formc">
        <option value="">Todos los asesores</option>
        <option>Israel</option><option>Selene</option><option>Diego</option><option>Yared</option><option>Gabriel</option>
      </select>
      <select id="fActividad" class="px-3 py-2 rounded-lg formc">
        <option value="">Todas las actividades</option>
        <option>Soporte de garantía</option>
        <option>Soporte fuera de garantía</option>
        <option>Instalación</option>
        <option>Evento</option>
        <option>Proyecto</option>
        <option>Curso</option>
        <option>Vacaciones</option>
      </select>
      <select id="fModalidad" class="px-3 py-2 rounded-lg formc">
        <option value="">Todas las modalidades</option>
        <option>Remoto</option>
        <option>Presencial</option>
      </select>
      <input id="fCiudad" class="px-3 py-2 rounded-lg formc" placeholder="Ciudad" />
      <input id="fRango" class="px-3 py-2 rounded-lg formc" placeholder="Rango fechas (YYYY-MM-DD a YYYY-MM-DD)" />
    </div>
    <div class="mt-3 flex gap-2">
      <button id="btnAplicarFiltros" class="btn btn-primary">Aplicar filtros</button>
      <button id="btnLimpiarFiltros" class="btn">Limpiar</button>
    </div>
  </section>

  <!-- Panel Map + Calendar + Charts -->
  <section class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-6">
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-medium">Mapa</h3>
        <div class="text-xs text-slate-400">Geolocalización por registro (lat/lng)</div>
      </div>
      <div id="map" class="rounded-lg overflow-hidden"></div>
    </div>

    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-medium">Calendario</h3>
        <div class="text-xs text-slate-400">Eventos por inicio/fin</div>
      </div>
      <div id="calendar" class="rounded-lg bg-slate-900"></div>
    </div>

    <div class="card p-4">
      <div class="flex items-center justify-between mb-3"><h3 class="text-lg font-medium">Actividades por asesor (apilado por tipo)</h3></div>
      <div class="h-[320px]"><canvas id="chartActAsesor"></canvas></div>
    </div>

    <div class="card p-4">
      <div class="flex items-center justify-between mb-3"><h3 class="text-lg font-medium">Remoto vs Presencial</h3></div>
      <div class="h-[320px]"><canvas id="chartRemoto"></canvas></div>
    </div>

    <div class="card p-4">
      <div class="flex items-center justify-between mb-3"><h3 class="text-lg font-medium">Distribución por actividad</h3></div>
      <div class="h-[320px]"><canvas id="chartActividad"></canvas></div>
    </div>

    <div class="card p-4">
      <div class="flex items-center justify-between mb-3"><h3 class="text-lg font-medium">Garantía vs No garantía</h3></div>
      <div class="h-[320px]"><canvas id="chartGarantia"></canvas></div>
    </div>

    <div class="card p-4 xl:col-span-2">
      <div class="flex items-center justify-between mb-3"><h3 class="text-lg font-medium">Ingresos por asesor (MXN)</h3></div>
      <div class="h-[360px]"><canvas id="chartIngresos"></canvas></div>
    </div>
  </section>

  <!-- Tabla Registros -->
  <section class="card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-medium">Registros</h2>
      <div class="flex gap-2"><button id="btnReload" class="btn">🔄 Recargar</button></div>
    </div>
    <div class="table-viewport">
      <table id="tbl" class="table-fixed w-full">
        <thead>
          <tr class="text-left text-slate-400">
            <th class="py-2 px-3">ID</th>
            <th class="py-2 px-3">Inicio</th>
            <th class="py-2 px-3">Fin</th>
            <th class="py-2 px-3">Asesor</th>
            <th class="py-2 px-3">Actividad</th>
            <th class="py-2 px-3">Modalidad</th>
            <th class="py-2 px-3 col-horas">Horas</th>
            <th class="py-2 px-3 col-money">Pot. Garantía</th>
            <th class="py-2 px-3 col-money">MO $</th>
            <th class="py-2 px-3 col-money">Ref $</th>
            <th class="py-2 px-3 col-money">Viáticos $</th>
            <th class="py-2 px-3 col-money">IVA $</th>
            <th class="py-2 px-3 col-money">Total $</th>
            <th class="py-2 px-3 col-money">Eq. Subtotal</th>
            <th class="py-2 px-3 col-money">Eq. Total</th>
            <th class="py-2 px-3 col-money">Costo Inst.</th>
            <th class="py-2 px-3">Ciudad</th>
            <th class="py-2 px-3 col-notas">Notas</th>
            <th class="py-2 px-3 col-acciones">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</div>

<!-- ===================== SCRIPTS ===================== -->
<script>
/* ====== CONFIG ====== */
const API_URL = 'https://script.google.com/macros/s/AKfycbyOtHBZuG13nxSbk0cD63UIK5SpmP3JPyqCyi2YUErsXYRfBmfBWDBDA_fCkoeoraEz/exec';  // ejemplo: https://script.google.com/macros/s/AKfycbx.../exec
const EDIT_TOKEN = '42673';
const TARIFA_GARANTIA = 1000; // $/hora
const TARIFA_INTERNA_INST = 85; // $/hora

/* ====== STATE ====== */
let ROWS = [];
let FILTERED = [];
let CAL = null;

/* ====== UTILS ====== */
function $(q){ return document.querySelector(q); }
function fmtMoney(n){ n = Number(n)||0; return n.toLocaleString('es-MX',{style:'currency',currency:'MXN',maximumFractionDigits:0}); }
function minutosEntre(h1,h2){ if(!h1||!h2) return 0; const [a,b]=h1.split(':').map(Number),[c,d]=h2.split(':').map(Number); return (c*60+d)-(a*60+b); }
function parseBloques(str){ try{return JSON.parse(str||'[]')}catch{return []} }
function horasTotalesFromBloques(bloques){
  const mins = bloques.reduce((acc,b)=>acc+Math.max(0,minutosEntre(b.inicio,b.fin)-(Number(b.breakMin)||0)),0);
  return Math.round((mins/60)*100)/100;
}
function totalCobrado(r){ return ['mo_monto','refacciones_monto','viaticos_monto','iva_monto'].reduce((a,k)=>a+(Number(r[k])||0),0); }
function isGarantia(r){ return String(r.garantia||'').trim().toLowerCase().startsWith('s'); }
function isInstalacion(r){ return (r.actividad||'').toString().toLowerCase().includes('instal'); }
function toISODate(d){ const m = dayjs(d,['YYYY-MM-DD','DD/MM/YYYY','YYYY/MM/DD'],true); return m.isValid()?m.format('YYYY-MM-DD'):null; }

/* ====== API ====== */
async function apiGet(){ const r=await fetch(API_URL); if(!r.ok) throw new Error('GET failed'); return r.json(); }

/* ====== RENDER PIPELINE ====== */
function deriveComputedFields(rows){
  rows.forEach(r=>{
    const h = horasTotalesFromBloques(parseBloques(r.bloques_horas));
    r.horas_totales = Number(h || r.horas_totales || 0);
    r.potencial_garantia = isGarantia(r) ? Math.round(r.horas_totales * TARIFA_GARANTIA) : 0;
    r.total_cobrado = totalCobrado(r);
  });
  return rows;
}
function applyFilters(){
  const a = ($('#fAsesor').value||'').trim().toLowerCase();
  const act = ($('#fActividad').value||'').trim().toLowerCase();
  const mod = ($('#fModalidad').value||'').trim().toLowerCase();
  const c  = ($('#fCiudad').value||'').trim().toLowerCase();
  const rng = ($('#fRango').value||'').trim();

  let out = ROWS.slice();
  if (a) out = out.filter(x => (x.asesor||'').toString().toLowerCase().includes(a));
  if (act) out = out.filter(x => (x.actividad||'').toString().toLowerCase() === act);
  if (mod) out = out.filter(x => (x.modalidad||'').toString().toLowerCase() === mod);
  if (c) out = out.filter(x => (x.ciudad||'').toString().toLowerCase().includes(c));
  if (rng && rng.includes('a')) {
    const [d1,d2] = rng.split('a').map(s=>s.trim());
    if (d1 && d2) {
      const t1=dayjs(d1,'YYYY-MM-DD'), t2=dayjs(d2,'YYYY-MM-DD').endOf('day');
      out = out.filter(x=>{
        const f = String(x.fecha_inicio||x.fecha_fin||'');
        const t = dayjs(f,['YYYY-MM-DD','DD/MM/YYYY']);
        return t.isValid() ? (t.isAfter(t1.subtract(1,'day')) && t.isBefore(t2.add(1,'second'))) : true;
      });
    }
  }
  FILTERED = out;
}

/* ====== KPIs ====== */
function renderKpis(){
  // nuevos
  $('#kpiTotal').textContent = FILTERED.length.toString();
  const sumPotGar = FILTERED.reduce((a,r)=> a + (Number(r.potencial_garantia)||0), 0);
  $('#kpiPotGarantia').textContent = fmtMoney(sumPotGar);
  const sumMo  = FILTERED.reduce((a,r)=> a + (Number(r.mo_monto)||0), 0);
  const sumRef = FILTERED.reduce((a,r)=> a + (Number(r.refacciones_monto)||0), 0);
  const sumVia = FILTERED.reduce((a,r)=> a + (Number(r.viaticos_monto)||0), 0);
  const sumIva = FILTERED.reduce((a,r)=> a + (Number(r.iva_monto)||0), 0);
  const sumCob = sumMo+sumRef+sumVia+sumIva;
  $('#kpiMo').textContent  = fmtMoney(sumMo);
  $('#kpiRef').textContent = fmtMoney(sumRef);
  $('#kpiVia').textContent = fmtMoney(sumVia);
  $('#kpiIva').textContent = fmtMoney(sumIva);
  $('#kpiCobradoTotal').textContent = fmtMoney(sumCob);

  const rowsInst = FILTERED.filter(isInstalacion);
  const sumValSub = rowsInst.reduce((a,r)=> a + (Number(r.equipos_valor_subtotal)||0), 0);
  const sumValTot = rowsInst.reduce((a,r)=> a + (Number(r.equipos_valor_total)||0), 0);
  const sumCostoInst = rowsInst.reduce((a,r)=> (Number(r.horas_totales)||0)*TARIFA_INTERNA_INST + (Number(r.viaticos_monto)||0), 0);
  $('#kpiInstValSub').textContent = fmtMoney(sumValSub);
  $('#kpiInstValTot').textContent = fmtMoney(sumValTot);
  $('#kpiInstCosto').textContent  = fmtMoney(sumCostoInst);
  $('#kpiInstRatio').textContent  = (sumCostoInst>0) ? (sumValSub/sumCostoInst).toFixed(2) : '—';

  // clásicos
  const isSoporte = r => (r.actividad||'').toLowerCase().includes('soporte');
  const isInst    = r => (r.actividad||'').toLowerCase().includes('instal');
  const isEvento  = r => /(evento|proy|curso)/i.test(r.actividad||'');
  $('#kpiC_total').textContent    = FILTERED.length;
  $('#kpiC_soporte').textContent  = FILTERED.filter(isSoporte).length;
  $('#kpiC_inst').textContent     = FILTERED.filter(isInst).length;
  $('#kpiC_eventos').textContent  = FILTERED.filter(isEvento).length;
  $('#kpiC_cobrado').textContent  = fmtMoney(sumCob);

  if (!window._TV_HRS_LOADED) {
    fetch('/conexionesimport.csv').then(r=> r.ok ? r.text(): '').then(txt=>{
      if (!txt) return;
      const lines = txt.trim().split(/\r?\n/).slice(1);
      const sumH = lines.reduce((acc,ln)=>{
        const cols = ln.split(',');
        const h = parseFloat(cols[2]||'0'); // col de horas
        return acc + (isFinite(h)?h:0);
      },0);
      $('#kpiC_tvhrs').textContent = (Math.round(sumH*100)/100).toString();
      window._TV_HRS_LOADED = true;
    }).catch(()=>{});
  }
}

/* ====== TABLA ====== */
function renderTable(){
  const tbody = $('#tbody'); tbody.innerHTML = '';
  FILTERED.forEach(r=>{
    const costoInst = isInstalacion(r) ? ((Number(r.horas_totales)||0)*TARIFA_INTERNA_INST + (Number(r.viaticos_monto)||0)) : 0;
    const tr = document.createElement('tr');
    tr.className = 'border-t border-white/10';
    tr.innerHTML = `
      <td class="py-2 px-3">${r.id||''}</td>
      <td class="py-2 px-3">${[r.fecha_inicio,r.hora_inicio].filter(Boolean).join(' ')}</td>
      <td class="py-2 px-3">${[r.fecha_fin,r.hora_fin].filter(Boolean).join(' ')}</td>
      <td class="py-2 px-3">${r.asesor||''}</td>
      <td class="py-2 px-3">
        ${r.actividad||''}
        ${isGarantia(r) ? '<span class="chip chip-warn ml-1">Garantía</span>' : ''}
        ${isInstalacion(r) ? '<span class="chip chip-ok ml-1">Instalación</span>' : ''}
      </td>
      <td class="py-2 px-3">${r.modalidad||''}</td>
      <td class="py-2 px-3 col-horas">${(Number(r.horas_totales)||0).toFixed(2)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.potencial_garantia||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.mo_monto||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.refacciones_monto||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.viaticos_monto||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.iva_monto||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.total_cobrado||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.equipos_valor_subtotal||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(r.equipos_valor_total||0)}</td>
      <td class="py-2 px-3 col-money">${fmtMoney(costoInst)}</td>
      <td class="py-2 px-3">${r.ciudad||''}</td>
      <td class="py-2 px-3"><div class="td-wrap line-clamp-4 whitespace-pre-wrap">${r.notas||''}</div></td>
      <td class="py-2 px-3 col-acciones"><button class="btn">⏱️</button> <button class="btn">✏️</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/* ====== MAPA ====== */
window.renderMapMarkers = function(){
  if (!window.MAP) return;
  if (window._MAP_MARKERS) window._MAP_MARKERS.forEach(m=>m.setMap && m.setMap(null));
  window._MAP_MARKERS = [];
  (FILTERED||[]).forEach(r=>{
    const lat = parseFloat(r.lat), lng = parseFloat(r.lng);
    if (!isFinite(lat) || !isFinite(lng)) return;
    const marker = addMapMarker(window.MAP, lat, lng, `${r.cliente||''} · ${r.ciudad||''}`);
    window._MAP_MARKERS.push(marker);
  });
};

/* ====== CALENDARIO ====== */
function renderCalendar(){
  const el = document.getElementById('calendar');
  if (CAL) { CAL.destroy(); CAL = null; }
  CAL = new FullCalendar.Calendar(el, {
    height: '100%',
    locale: 'es',
    initialView: 'dayGridMonth',
    headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,listWeek' },
    events: FILTERED.map(r=>{
      const dStart = toISODate(r.fecha_inicio || r.fecha_fin);
      const dEnd   = toISODate(r.fecha_fin   || r.fecha_inicio);
      const start  = dStart ? `${dStart}T${(r.hora_inicio||'00:00')}` : undefined;
      const end    = dEnd   ? `${dEnd}T${(r.hora_fin||'00:00')}`     : undefined;
      return { title:`${r.actividad||''} — ${r.asesor||''}`, start, end, allDay: !((r.hora_inicio||'')||(r.hora_fin||'')), extendedProps:{id:r.id} };
    }),
    eventClick(info){ /* abrir modal si quieres */ }
  });
  CAL.render();
}

/* ====== CHARTS ====== */
function renderCharts(){
  // Actividades por asesor (apilado)
  (function(){
    const c = document.getElementById('chartActAsesor'); if(!c) return;
    const asesores = [...new Set(FILTERED.map(r=>r.asesor||'Sin dato'))];
    const tipos = ['Soporte de garantía','Soporte fuera de garantía','Instalación','Evento','Proyecto','Curso','Vacaciones'];
    const series = tipos.map(t => asesores.map(a => FILTERED.filter(r=> (r.asesor||'Sin dato')===a && (r.actividad||'')===t).length));
    new Chart(c,{type:'bar',
      data:{labels:asesores, datasets:tipos.map((t,i)=>({label:t,data:series[i],stack:'stack1'}))},
      options:{responsive:true, maintainAspectRatio:false, scales:{x:{stacked:true}, y:{stacked:true}}}
    });
  })();

  // Remoto vs Presencial
  (function(){
    const c = document.getElementById('chartRemoto'); if(!c) return;
    const rem = FILTERED.filter(r=> (r.modalidad||'').toLowerCase()==='remoto').length;
    const pre = FILTERED.filter(r=> (r.modalidad||'').toLowerCase()==='presencial').length;
    new Chart(c,{type:'doughnut',data:{labels:['Remoto','Presencial'],datasets:[{data:[rem,pre]}]},options:{responsive:true,maintainAspectRatio:false}});
  })();

  // Distribución por actividad (dona)
  (function(){
    const c = document.getElementById('chartActividad'); if(!c) return;
    const byAct = {}; FILTERED.forEach(r=>{ const k=r.actividad||'Sin dato'; byAct[k]=(byAct[k]||0)+1; });
    new Chart(c,{type:'doughnut',data:{labels:Object.keys(byAct),datasets:[{data:Object.values(byAct)}]},options:{responsive:true,maintainAspectRatio:false}});
  })();

  // Garantía vs No garantía
  (function(){
    const c = document.getElementById('chartGarantia'); if(!c) return;
    const si = FILTERED.filter(isGarantia).length; const no = FILTERED.length - si;
    new Chart(c,{type:'doughnut',data:{labels:['Garantía','No garantía'],datasets:[{data:[si,no]}]},options:{responsive:true,maintainAspectRatio:false}});
  })();

  // Ingresos por asesor
  (function(){
    const c = document.getElementById('chartIngresos'); if(!c) return;
    const byA={}; FILTERED.forEach(r=>{ const k=r.asesor||'Sin dato'; byA[k]=(byA[k]||0)+(Number(r.total_cobrado)||0); });
    new Chart(c,{type:'bar',data:{labels:Object.keys(byA),datasets:[{label:'MXN',data:Object.values(byA)}]},options:{responsive:true,maintainAspectRatio:false}});
  })();
}

/* ====== RENDER ALL ====== */
function renderAll(){
  renderKpis();
  renderTable();
  renderCalendar();
  renderCharts();
  renderMapMarkers();
}

/* ====== BOOT ====== */
async function boot(){
  // selector de mes (opcional visual)
  const sel = $('#fMes'); if (sel && !sel._filled){
    const now = dayjs(); const items=[];
    for(let i=0;i<12;i++){ const d=now.subtract(i,'month'); items.push(`<option value="${d.format('YYYY-MM')}">${d.format('MMMM YYYY')}</option>`); }
    sel.innerHTML = items.join(''); sel._filled=true;
  }
  try{ ROWS = await apiGet(); }catch(e){ console.error(e); alert('Error obteniendo datos'); return; }
  deriveComputedFields(ROWS);
  applyFilters();
  renderAll();
}
document.getElementById('btnReload').addEventListener('click', boot);
document.getElementById('btnAplicarFiltros').addEventListener('click', ()=>{ applyFilters(); renderAll(); });
document.getElementById('btnLimpiarFiltros').addEventListener('click', ()=>{ $('#fAsesor').value=''; $('#fActividad').value=''; $('#fModalidad').value=''; $('#fCiudad').value=''; $('#fRango').value=''; applyFilters(); renderAll(); });
document.getElementById('btnExportPdf').addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf; const doc = new jsPDF('p','pt','a4');
  const el = document.body; const canvas = await html2canvas(el,{scale:2});
  const imgData = canvas.toDataURL('image/png');
  const pw = doc.internal.pageSize.getWidth(), ph = doc.internal.pageSize.getHeight();
  const ratio = Math.min(pw/canvas.width, ph/canvas.height);
  const iw = canvas.width*ratio, ih = canvas.height*ratio;
  doc.addImage(imgData,'PNG',(pw-iw)/2,10,iw,ih); doc.save('reporte_mdc.pdf');
});
boot();
</script>

<!-- Google Maps: initMap global + helper de marcadores y carga async -->
<script>
  window.initMap = function(){
    const center = { lat: 23.6345, lng: -102.5528 };
    window.MAP = new google.maps.Map(document.getElementById('map'), { center, zoom: 5 });
    if (typeof window.renderMapMarkers === 'function') window.renderMapMarkers();
  };
  window.addMapMarker = function(map, lat, lng, title){
    try {
      const mod = google.maps.marker;
      if (mod && mod.AdvancedMarkerElement) {
        return new mod.AdvancedMarkerElement({ map, position:{lat,lng}, title:title||'' });
      }
    } catch(e){}
    return new google.maps.Marker({ map, position:{lat,lng}, title:title||'' });
  };
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1uE6o9Yw9AXq7vxmQiJKPSX08RZvh9N4&libraries=places&loading=async&callback=initMap" async defer></script>

</body>
</html>
