<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MDC — Reporte Mensual de Actividades Asesores CAD-CAM</title>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.min.js"></script>
  <script>dayjs.extend(window.dayjs_plugin_isoWeek);dayjs.extend(window.dayjs_plugin_customParseFormat);</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/core/locales-all.global.min.js"></script>

  <!-- Google Maps (Maps + Places) -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1uE6o9Yw9AXq7vxmQiJKPSX08RZvh9N4&libraries=places&callback=initMap"></script>

  <!-- Export PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body{background:#0b0d10;color:#e5e7eb}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));background-color:#12161b;border:1px solid rgba(255,255,255,.06);border-radius:1rem}
    .dot{display:inline-block;width:10px;height:10px;border-radius:9999px;margin-right:.5rem}
    #map{min-height:420px;height:420px}
    #calendar{height:820px;}
    .formc{background-color:#1e293b;color:#f1f5f9;border:1px solid #334155}
    .formc::placeholder{color:#cbd5e1}
    select.formc option{color:#000}
    .chart-h{height:300px}
    .chart-h-lg{height:320px}
  </style>
</head>
<body class="h-full">
<div class="max-w-7xl mx-auto p-4 sm:p-6">

  <!-- HEADER -->
  <header class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-4">
    <div class="flex items-center gap-3">
      <img src="logo-mdc.png" alt="MDC Digital" class="h-10">
      <div>
        <h1 class="text-2xl font-semibold">MDC Digital — Reporte de Actividades Asesores CAD-CAM</h1>
        <p class="text-sm text-slate-400">Captura · KPIs · Mapas · Calendario · PDF</p>
      </div>
    </div>
    <div class="flex flex-wrap gap-2 items-center">
      <select id="monthSelect" class="card px-3 py-2 text-sm formc"></select>
      <button id="exportPdfBtn" class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-black font-medium">Exportar PDF</button>
    </div>
  </header>

  <div id="banner" class="hidden card p-3 mb-4 text-sm"></div>

  <!-- KPIs -->
  <section id="kpis" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
    <div class="card p-4"><div class="text-slate-400 text-xs">Total registros</div><div id="kpiTotal" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs"><span class="dot bg-emerald-400"></span>Soporte</div><div id="kpiSoporte" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs"><span class="dot bg-sky-400"></span>Instalaciones</div><div id="kpiInst" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs"><span class="dot bg-amber-400"></span>Eventos/Proy./Cursos</div><div id="kpiEvt" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs"><span class="dot bg-fuchsia-400"></span>Total cobrado</div><div id="kpiCobrado" class="text-3xl font-semibold mt-1">$0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs"><span class="dot bg-cyan-400"></span>Conexiones TeamViewer</div><div id="kpiTvConn" class="text-3xl font-semibold mt-1">0</div></div>
    <div class="card p-4"><div class="text-slate-400 text-xs"><span class="dot bg-indigo-400"></span>Horas TeamViewer</div><div id="kpiTvHours" class="text-3xl font-semibold mt-1">0</div></div>
  </section>

  <!-- FILTROS -->
  <section class="card p-4 mb-6">
    <h2 class="text-lg font-medium mb-3">Filtros</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
      <select id="fTecnico" class="px-3 py-2 rounded-lg formc">
        <option value="">Todos los asesores</option>
        <option>Israel</option><option>Selene</option><option>Diego</option><option>Yared</option><option>Gabriel</option>
      </select>
      <select id="fActividad" class="px-3 py-2 rounded-lg formc">
        <option value="">Todas las actividades</option>
        <option>Soporte de garantía</option>
        <option>Soporte fuera de garantía</option>
        <option>Instalación</option>
        <option>Evento</option>
        <option>Proyecto</option>
        <option>Curso</option>
        <option>Vacaciones</option>
      </select>
      <select id="fModalidad" class="px-3 py-2 rounded-lg formc">
        <option value="">Remoto/Presencial</option><option>Remoto</option><option>Presencial</option>
      </select>
      <select id="fGarantia" class="px-3 py-2 rounded-lg formc">
        <option value="">Garantía / No</option><option>Sí</option><option>No</option>
      </select>
      <input id="fBusqueda" placeholder="Buscar cliente/ciudad/nota" class="px-3 py-2 rounded-lg formc" />
    </div>
  </section>

  <!-- GRÁFICAS -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
    <div class="card p-4"><h3 class="mb-2">Actividades por asesor</h3><div class="chart-h-lg"><canvas id="chartTechCount"></canvas></div></div>
    <div class="card p-4"><h3 class="mb-2">Remoto vs Presencial</h3><div class="chart-h-lg"><canvas id="chartRemPre"></canvas></div></div>
  </section>
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
    <div class="card p-4"><h3 class="mb-2">Distribución por actividad</h3><div class="chart-h"><canvas id="chartActividad"></canvas></div></div>
    <div class="card p-4"><h3 class="mb-2">Garantía vs No garantía</h3><div class="chart-h"><canvas id="chartGarantia"></canvas></div></div>
  </section>
  <section class="card p-4 mb-6">
    <h3 class="mb-2">Ingresos por asesor (MXN)</h3>
    <div class="chart-h-lg"><canvas id="chartRevenue"></canvas></div>
  </section>
  <section class="card p-4 mb-6">
    <h3 class="mb-2">TeamViewer — Conexiones y horas (CSV)</h3>
    <div class="text-xs text-slate-400 mb-3">Fuente: <code>/connectionreport.csv</code></div>
    <div class="chart-h-lg"><canvas id="chartTV"></canvas></div>
    <div id="tvBanner" class="text-xs text-slate-400 mt-2"></div>
  </section>

  <!-- MAPA -->
  <section class="card p-4 mb-6">
    <h3 class="mb-2">Mapa de cobertura</h3>
    <div id="map" class="w-full rounded-xl"></div>
  </section>

  <!-- CALENDARIO -->
  <section class="card p-4 mb-6">
    <div class="flex items-center justify-between mb-2">
      <h3>Calendario de actividades</h3>
      <div class="text-xs text-slate-400">Vista mensual · colores por actividad</div>
    </div>
    <div id="calendar" class="rounded-xl overflow-hidden"></div>
  </section>

  <!-- CAPTURAR -->
  <!-- ... aquí iría tu bloque de formulario y registros igual que antes ... -->

  <!-- FOOTER -->
  <footer class="text-center text-xs text-slate-500 pb-10">
    © MDC Dental — Reporte Mensual · Desarrollado por Israel Landa Fuentes
  </footer>
</div>

<script>
/* ... aquí tu JS existente ... */

// === renderCalendar PATCH ===
function renderCalendar(rows){
  const calEl=document.getElementById('calendar');
  if(!calEl) return;
  const [y,m]=state.month.split('-');
  const inMonth=rows.filter(r=>{
    const d=parseDay(r.fecha_inicio||r.fecha);
    return d && d.format('YYYY-MM')===`${y}-${m}`;
  });
  const events=inMonth.map(r=>({
    id:r.id||undefined,
    title:`${r.actividad||''} — ${r.asesor||r.tecnico||''}`,
    start:r.fecha_inicio?`${r.fecha_inicio}T${r.hora_inicio||'00:00'}`:undefined,
    end:r.fecha_fin?`${r.fecha_fin}T${r.hora_fin||'23:59'}`:undefined
  })).filter(e=>e.start);

  const firstDay=dayjs(`${state.month}-01`).toDate();
  if(state.calendar){
    state.calendar.removeAllEvents();
    events.forEach(ev=>state.calendar.addEvent(ev));
    state.calendar.gotoDate(firstDay);
  }else{
    state.calendar=new FullCalendar.Calendar(calEl,{
      initialView:'dayGridMonth',
      height:'100%',
      headerToolbar:{left:'prev,next today',center:'title',right:''},
      firstDay:1,
      locale:'es',
      events,
      eventDisplay:'block',
      dayMaxEventRows:true
    });
    state.calendar.render();
    state.calendar.gotoDate(firstDay);
  }
}

// === renderAll PATCH ===
function renderAll(){
  const rows=getFiltered();
  renderKPIs(rows);
  renderCharts(rows);
  renderTable(rows);
  renderMarkers(rows);
  renderTeamViewerChart();
  renderCalendar(rows); // <-- calendario
}
</script>
</body>
</html>
