<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MDC — Reporte Mensual de Servicio Técnico</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.min.js"></script>
  <script>
    dayjs.extend(window.dayjs_plugin_isoWeek);
    dayjs.extend(window.dayjs_plugin_customParseFormat);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <!-- Google Maps JS API (Maps + Places) -->
  <script>
    const GOOGLE_MAPS_API_KEY = "AIzaSyD1uE6o9Yw9AXq7vxmQiJKPSX08RZvh9N4";
  </script>
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1uE6o9Yw9AXq7vxmQiJKPSX08RZvh9N4&libraries=places"></script>

  <!-- Exportar a PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root{color-scheme:dark light}
    body{--bg:#0b0d10; --card:#12161b; --muted:#9aa4b2; --brand:#22c55e}
    body{background:var(--bg); color:#e5e7eb}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); background-color:var(--card); border:1px solid rgba(255,255,255,0.06); border-radius:1rem}
    .dot{display:inline-block;width:10px;height:10px;border-radius:9999px;margin-right:.5rem}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body class="h-full">
  <div class="max-w-7xl mx-auto p-4 sm:p-6">
    <header class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-emerald-500/10 flex items-center justify-center border border-emerald-400/20">
          <i data-lucide="activity" class="w-6 h-6 text-emerald-400"></i>
        </div>
        <div>
          <h1 class="text-2xl font-semibold">MDC — Reporte de Actividades de Servicio Técnico</h1>
          <p class="text-sm text-slate-400">Captura + KPIs + Mapas + PDF</p>
        </div>
      </div>
      <div class="flex flex-wrap gap-2 items-center">
        <select id="monthSelect" class="card px-3 py-2 text-sm"></select>
        <button id="exportPdfBtn" class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-black font-medium">Exportar PDF</button>
      </div>
    </header>

    <div id="banner" class="hidden card p-3 mb-4 text-sm"></div>

    <!-- KPIs -->
    <section id="kpis" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
      <div class="card p-4"><div class="text-slate-400 text-xs">Servicios totales</div><div id="kpiTotal" class="text-3xl font-semibold mt-1">0</div></div>
      <div class="card p-4"><div class="text-slate-400 text-xs"><span class="dot bg-emerald-400"></span>Remoto</div><div id="kpiRemoto" class="text-3xl font-semibold mt-1">0</div></div>
      <div class="card p-4"><div class="text-slate-400 text-xs"><span class="dot bg-sky-400"></span>Presencial</div><div id="kpiPresencial" class="text-3xl font-semibold mt-1">0</div></div>
      <div class="card p-4"><div class="text-slate-400 text-xs"><span class="dot bg-amber-400"></span>Garantía</div><div id="kpiGarantia" class="text-3xl font-semibold mt-1">0</div></div>
      <div class="card p-4"><div class="text-slate-400 text-xs"><span class="dot bg-fuchsia-400"></span>Total cobrado</div><div id="kpiCobrado" class="text-3xl font-semibold mt-1">$0</div></div>
    </section>

    <!-- Filtros -->
    <section class="card p-4 mb-6">
      <h2 class="text-lg font-medium mb-3">Filtros</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
        <select id="fTecnico" class="px-3 py-2 rounded-lg bg-white/5 border border-white/10">
          <option value="">Todos los técnicos</option><option>Israel</option><option>Selene</option><option>Diego</option><option>Yared</option>
        </select>
        <select id="fTipo" class="px-3 py-2 rounded-lg bg-white/5 border border-white/10">
          <option value="">Remoto/Presencial</option><option>Remoto</option><option>Presencial</option>
        </select>
        <select id="fGarantia" class="px-3 py-2 rounded-lg bg-white/5 border border-white/10">
          <option value="">Garantía / No</option><option>Sí</option><option>No</option>
        </select>
        <input id="fBusqueda" placeholder="Buscar cliente/ciudad/nota" class="px-3 py-2 rounded-lg bg-white/5 border border-white/10" />
      </div>
    </section>

    <!-- Gráficas -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
      <div class="card p-4"><h3 class="mb-2">Remoto/Presencial por técnico</h3><canvas id="chartStack"></canvas></div>
      <div class="card p-4"><h3 class="mb-2">Distribución por tipo</h3><canvas id="chartTipo"></canvas></div>
      <div class="card p-4"><h3 class="mb-2">Garantía vs No garantía</h3><canvas id="chartGarantia"></canvas></div>
    </section>

    <section class="card p-4 mb-6">
      <h3 class="mb-2">Ingresos por técnico (MXN)</h3>
      <canvas id="chartRevenue"></canvas>
    </section>

    <!-- Mapa -->
    <section class="card p-4 mb-6">
      <div class="flex items-center justify-between mb-3">
        <h3>Mapa de cobertura</h3>
        <div class="text-xs text-slate-400">Tip: escribe dirección, usa tu GPS o haz clic en el mapa.</div>
      </div>
      <div id="map" class="w-full h-[420px] rounded-xl"></div>
    </section>

    <!-- Tabla y captura -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-16">
      <!-- Tabla -->
      <div class="card p-4 overflow-hidden">
        <div class="flex items-center justify-between mb-2">
          <h3>Registros</h3>
          <button id="btnExportCSV" class="text-xs px-3 py-1 rounded-lg border border-white/10 hover:bg-white/5">Descargar CSV</button>
        </div>
        <div class="overflow-auto max-h-[520px]">
          <table class="w-full text-sm">
            <thead class="sticky top-0 bg-black/30">
              <tr class="text-left text-slate-400">
                <th class="py-2 pr-3">Inicio</th>
                <th class="py-2 pr-3">Fin</th>
                <th class="py-2 pr-3">Técnico</th>
                <th class="py-2 pr-3">Tipo</th>
                <th class="py-2 pr-3">Garantía</th>
                <th class="py-2 pr-3">Cobrado</th>
                <th class="py-2 pr-3">Monto</th>
                <th class="py-2 pr-3">Cliente</th>
                <th class="py-2 pr-3">Teléfono</th>
                <th class="py-2 pr-3">Ciudad</th>
                <th class="py-2 pr-3">Notas</th>
              </tr>
            </thead>
            <tbody id="tbody" class="divide-y divide-white/5"></tbody>
          </table>
        </div>
      </div>
      <!-- Captura -->
      <div class="card p-4">
        <h3 class="mb-2">Capturar servicio</h3>
        <form id="form" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-400">Inicio — fecha</label>
            <input name="fecha_inicio" type="date" required class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10" />
          </div>
          <div>
            <label class="text-xs text-slate-400">Inicio — hora</label>
            <input name="hora_inicio" type="time" required class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10" />
          </div>
          <div>
            <label class="text-xs text-slate-400">Fin — fecha</label>
            <input name="fecha_fin" type="date" required class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10" />
          </div>
          <div>
            <label class="text-xs text-slate-400">Fin — hora</label>
            <input name="hora_fin" type="time" required class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10" />
          </div>
          <div>
            <label class="text-xs text-slate-400">Técnico</label>
            <select name="tecnico" required class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10">
              <option value="Israel">Israel</option><option value="Selene">Selene</option><option value="Diego">Diego</option><option value="Yared">Yared</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-400">Tipo</label>
            <select name="tipo" required class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10"><option>Remoto</option><option>Presencial</option></select>
          </div>
          <div>
            <label class="text-xs text-slate-400">¿Garantía?</label>
            <select name="garantia" required class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10"><option>Sí</option><option>No</option></select>
          </div>
          <div class="sm:col-span-2">
            <label class="text-xs text-slate-400">Cliente</label>
            <input id="cliente" name="cliente" list="dlClientes" placeholder="Nombre del cliente" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10" />
            <datalist id="dlClientes"></datalist>
          </div>
          <div>
            <label class="text-xs text-slate-400">Teléfono</label>
            <input id="telefono" name="telefono" type="tel" placeholder="10 dígitos" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10" />
          </div>
          <div>
            <label class="text-xs text-slate-400">Dirección o ciudad</label>
            <input id="direccion" name="ciudad" placeholder="Ej. Av. Vallarta 6500, Zapopan" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10" />
            <div class="mt-2 flex gap-2">
              <button type="button" id="btnUbicacion" class="px-3 py-1.5 text-xs rounded-lg bg-white/5 border border-white/10 hover:bg-white/10">📍 Usar mi ubicación</button>
              <span class="text-xs text-slate-400">o haz clic en el mapa para fijar el punto</span>
            </div>
          </div>
          <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div>
              <label class="text-xs text-slate-400">¿Servicio cobrado?</label>
              <select id="cobrado" name="cobrado" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10">
                <option>No</option><option>Sí</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-slate-400">Monto (MXN)</label>
              <input id="monto" name="monto" type="number" step="0.01" min="0" placeholder="0.00" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10" />
            </div>
            <div class="flex items-end">
              <button class="w-full px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-black font-medium" type="submit">Guardar</button>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div><label class="text-xs text-slate-400">Lat</label><input name="lat" id="lat" type="number" step="any" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10" readonly /></div>
            <div><label class="text-xs text-slate-400">Lng</label><input name="lng" id="lng" type="number" step="any" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10" readonly /></div>
          </div>
          <div class="sm:col-span-2"><label class="text-xs text-slate-400">Notas</label><textarea name="notas" rows="2" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10" placeholder="Descripción breve del soporte"></textarea></div>
        </form>
      </div>
    </section>

    <footer class="text-center text-xs text-slate-500 pb-10">© MDC Dental — Sistema de Reporte Mensual · v1.2</footer>
  </div>

<script>
// ========= CONFIG =========
const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxEuF70m2SSBhmLiB8yWSawJrZeD6Q_EEJJM7aPNLxW5-7xED81ofgugHGmPYjzIWDK/exec"; // Pega tu Web App /exec aquí

// ========= DEMO =========
const demoData = [
  {fecha_inicio:"2025-08-02", hora_inicio:"09:00", fecha_fin:"2025-08-02", hora_fin:"10:15", tecnico:"Israel", tipo:"Remoto", garantia:"Sí", cliente:"Clínica Sonrisa Feliz", telefono:"3312345678", ciudad:"Guadalajara, JAL", notas:"Actualización de software", lat:20.6736, lng:-103.344, cobrado:"Sí", monto:1200},
  {fecha_inicio:"2025-08-03", hora_inicio:"11:30", fecha_fin:"2025-08-03", hora_fin:"14:00", tecnico:"Selene", tipo:"Presencial", garantia:"No", cliente:"Dental Zapopan", telefono:"3323456789", ciudad:"Zapopan, JAL", notas:"Calibración fresadora", lat:20.7236, lng:-103.389, cobrado:"No", monto:0},
  {fecha_inicio:"2025-08-05", hora_inicio:"08:15", fecha_fin:"2025-08-05", hora_fin:"09:00", tecnico:"Diego", tipo:"Remoto", garantia:"Sí", cliente:"Sonrisas del Bajío", telefono:"4771234567", ciudad:"León, GTO", notas:"Diagnóstico remoto", lat:21.1221, lng:-101.68, cobrado:"Sí", monto:800}
];

let state = {
  rows: [],
  month: dayjs().format('YYYY-MM'),
  filters: { tecnico:"", tipo:"", garantia:"", q:"" },
  charts: {},
  clientBook: {}, // cliente -> telefono (para autocompletar)
};

// ========= UI helpers =========
function setBanner(msg, type="info"){
  const el = document.getElementById('banner');
  el.classList.remove('hidden'); el.innerText = msg;
  el.className = `card p-3 mb-4 text-sm ${type==='error'?'border-red-500/40 text-red-300':''}`;
}
function hideBanner(){ document.getElementById('banner').classList.add('hidden'); }

// ========= Month select =========
function initMonthSelect(){
  const sel = document.getElementById('monthSelect');
  const months = []; const base = dayjs();
  for(let i=0;i<12;i++){ months.push(base.subtract(i,'month').format('YYYY-MM')); }
  sel.innerHTML = months.map(m => `<option value="${m}">${dayjs(m+'-01').format('MMMM YYYY')}</option>`).join('');
  sel.value = state.month; sel.addEventListener('change', e=>{ state.month = e.target.value; renderAll(); });
}

// ========= Load/Save =========
async function loadData(){
  try{
    if(!SHEETS_ENDPOINT){
      setBanner('Modo DEMO: conecta tu Google Sheet para usar datos reales.');
      state.rows = demoData.slice();
    } else {
      const res = await fetch(SHEETS_ENDPOINT); if(!res.ok) throw new Error('No se pudo leer el endpoint');
      const data = await res.json();
      state.rows = (Array.isArray(data)?data:[]).map(normalizeRowFromSheet);
    }
    rebuildClientBook();
    populateClientDatalist();
  }catch(err){
    console.error(err);
    setBanner('No se pudo conectar con el Sheet. Cargando datos DEMO.','error');
    state.rows = demoData.slice();
    rebuildClientBook();
    populateClientDatalist();
  }
}

function normalizeRowFromSheet(r){
  const row = {
    fecha_inicio: r.fecha_inicio || r['fecha inicio'] || r.fecha || r.Fecha || '',
    hora_inicio: r.hora_inicio || r['hora inicio'] || r.hora || r.Hora || '',
    fecha_fin: r.fecha_fin || r['fecha fin'] || r.fecha || r.Fecha || '',
    hora_fin: r.hora_fin || r['hora fin'] || '',
    tecnico: r.tecnico || r.Técnico || r.Tecnico,
    tipo: r.tipo || r.Tipo,
    garantia: r.garantia || r.Garantia || r.Garantía,
    cliente: r.cliente || r.Cliente,
    telefono: r.telefono || r.Teléfono || r.Telefono || '',
    ciudad: r.ciudad || r.Ciudad,
    notas: r.notas || r.Notas || '',
    lat: r.lat? Number(r.lat): undefined,
    lng: r.lng? Number(r.lng): undefined,
    cobrado: r.cobrado || r.Cobrado || 'No',
    monto: r.monto? Number(r.monto) : 0,
  };
  return row;
}

async function saveRow(payload){
  try{
    if(!SHEETS_ENDPOINT){
      state.rows.push(payload);
      upsertClient(payload.cliente, payload.telefono);
      setBanner('Guardado local (DEMO). Conecta tu Sheet para persistir.','info');
      renderAll();
      return;
    }
    const res = await fetch(SHEETS_ENDPOINT, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error('Error al guardar');
    await loadData(); hideBanner(); renderAll();
  }catch(err){
    console.error(err); setBanner('Error al guardar. Revisa tu Apps Script/endpoint.','error');
  }
}

// ========= Client autocomplete =========
function loadClientBookLS(){
  try{ const raw = localStorage.getItem('mdc_client_book'); return raw? JSON.parse(raw): {}; }catch(e){ return {}; }
}
function saveClientBookLS(){
  localStorage.setItem('mdc_client_book', JSON.stringify(state.clientBook));
}
function upsertClient(nombre, tel){
  if(!nombre) return;
  state.clientBook[nombre] = tel || state.clientBook[nombre] || '';
  saveClientBookLS();
  populateClientDatalist();
}
function rebuildClientBook(){
  state.clientBook = loadClientBookLS();
  state.rows.forEach(r=>{ if(r.cliente){ upsertClient(r.cliente, r.telefono); } });
}
function populateClientDatalist(){
  const dl = document.getElementById('dlClientes');
  const names = Object.keys(state.clientBook).sort();
  dl.innerHTML = names.map(n => `<option value="${n}"></option>`).join('');
  // auto-fill phone if known
  const clienteInput = document.getElementById('cliente');
  const telInput = document.getElementById('telefono');
  clienteInput?.addEventListener('change', ()=>{
    const name = clienteInput.value;
    if(name && state.clientBook[name]){
      telInput.value = state.clientBook[name];
    }
  });
}

// ========= Filters =========
function getStartISO(r){
  const d = dayjs(`${r.fecha_inicio} ${r.hora_inicio || '00:00'}`, 'YYYY-MM-DD HH:mm');
  return d.isValid() ? d.format() : null;
}
function getFiltered(){
  const {tecnico,tipo,garantia,q} = state.filters;
  const [y,m] = state.month.split('-');
  return state.rows.filter(r=>{
    const start = r.fecha_inicio || r.fecha;
    const inMonth = start && dayjs(start).format('YYYY-MM')===`${y}-${m}`;
    if(!inMonth) return false;
    if(tecnico && r.tecnico!==tecnico) return false;
    if(tipo && r.tipo!==tipo) return false;
    if(garantia && r.garantia!==garantia) return false;
    if(q){
      const s = `${r.cliente||''} ${r.ciudad||''} ${r.notas||''}`.toLowerCase();
      if(!s.includes(q.toLowerCase())) return false;
    }
    return true;
  });
}

// ========= KPIs / Charts =========
function formatMoney(n){ try{ return n.toLocaleString('es-MX', {style:'currency', currency:'MXN'}); } catch(e){ return '$'+n.toFixed(2); } }

function renderKPIs(rows){
  const total = rows.length;
  const remoto = rows.filter(r=>r.tipo==='Remoto').length;
  const presencial = rows.filter(r=>r.tipo==='Presencial').length;
  const garantia = rows.filter(r=>r.garantia==='Sí').length;
  const cobrado = rows.reduce((acc,r)=> acc + (r.cobrado==='Sí' ? (Number(r.monto)||0) : 0), 0);
  document.getElementById('kpiTotal').innerText = total;
  document.getElementById('kpiRemoto').innerText = `${remoto} (${total?Math.round(remoto*100/total):0}%)`;
  document.getElementById('kpiPresencial').innerText = `${presencial} (${total?Math.round(presencial*100/total):0}%)`;
  document.getElementById('kpiGarantia').innerText = `${garantia} (${total?Math.round(garantia*100/total):0}%)`;
  document.getElementById('kpiCobrado').innerText = formatMoney(cobrado);
}

function ensureChart(id, config){
  const ctx = document.getElementById(id).getContext('2d');
  if(state.charts[id]){ state.charts[id].destroy(); }
  state.charts[id] = new Chart(ctx, config);
}

function renderCharts(rows){
  const tecnicos = ['Israel','Selene','Diego','Yared'];
  const rem = tecnicos.map(t => rows.filter(r=>r.tecnico===t && r.tipo==='Remoto').length);
  const pre = tecnicos.map(t => rows.filter(r=>r.tecnico===t && r.tipo==='Presencial').length);
  ensureChart('chartStack', { type:'bar', data:{ labels: tecnicos, datasets:[
    {label:'Remoto', data: rem},
    {label:'Presencial', data: pre},
  ]}, options:{ plugins:{legend:{position:'bottom'}}, scales:{ x:{stacked:true, grid:{display:true}}, y:{stacked:true, beginAtZero:true, grid:{display:true}} } } });

  const cRem = rows.filter(r=>r.tipo==='Remoto').length;
  const cPre = rows.filter(r=>r.tipo==='Presencial').length;
  ensureChart('chartTipo', { type:'doughnut', data:{ labels:['Remoto','Presencial'], datasets:[{ data:[cRem,cPre] }] }, options:{ plugins:{legend:{position:'bottom'}} }});

  const cG = rows.filter(r=>r.garantia==='Sí').length;
  const cNG = rows.filter(r=>r.garantia==='No').length;
  ensureChart('chartGarantia', { type:'doughnut', data:{ labels:['Garantía','No garantía'], datasets:[{ data:[cG,cNG] }] }, options:{ plugins:{legend:{position:'bottom'}} }});

  // Revenue by technician
  const rev = tecnicos.map(t => rows.reduce((sum,r)=> sum + (r.tecnico===t && r.cobrado==='Sí' ? (Number(r.monto)||0) : 0), 0));
  ensureChart('chartRevenue', { type:'bar', data:{ labels: tecnicos, datasets:[{ label:'MXN', data: rev }] }, options:{ plugins:{legend:{display:false}, tooltip:{callbacks:{label:(ctx)=> formatMoney(ctx.parsed.y)}}}, scales:{ y:{beginAtZero:true, ticks:{callback:(v)=> formatMoney(v)}} }}});
}

// ========= Table =========
function renderTable(rows){
  const tbody = document.getElementById('tbody');
  function fmt(dt, tm){ if(!dt) return ''; return tm ? `${dayjs(`${dt} ${tm}`).format('DD/MM/YYYY HH:mm')}` : `${dayjs(dt).format('DD/MM/YYYY')}`; }
  tbody.innerHTML = rows.map(r=>`
    <tr>
      <td class="py-2 pr-3 nowrap">${fmt(r.fecha_inicio, r.hora_inicio)}</td>
      <td class="py-2 pr-3 nowrap">${fmt(r.fecha_fin, r.hora_fin)}</td>
      <td class="py-2 pr-3">${r.tecnico}</td>
      <td class="py-2 pr-3">${r.tipo}</td>
      <td class="py-2 pr-3">${r.garantia}</td>
      <td class="py-2 pr-3">${r.cobrado||'No'}</td>
      <td class="py-2 pr-3">${r.cobrado==='Sí' ? formatMoney(Number(r.monto)||0) : ''}</td>
      <td class="py-2 pr-3">${r.cliente||''}</td>
      <td class="py-2 pr-3">${r.telefono||''}</td>
      <td class="py-2 pr-3">${r.ciudad||''}</td>
      <td class="py-2 pr-3 max-w-[320px] truncate" title="${r.notas||''}">${r.notas||''}</td>
    </tr>
  `).join('');
}

// ========= Google Maps =========
let gmap = null, gmarkers = [], geocoder = null, placeAutocomplete = null, clickMarker = null;

function ensureGoogleReady(){
  return new Promise(resolve=>{
    if (window.google && window.google.maps) return resolve();
    const iv = setInterval(()=>{
      if (window.google && window.google.maps){ clearInterval(iv); resolve(); }
    }, 100);
  });
}
async function initMap(){
  await ensureGoogleReady();
  geocoder = new google.maps.Geocoder();
  gmap = new google.maps.Map(document.getElementById('map'), {
    center: { lat: 22.0, lng: -102.0 }, zoom: 5, mapTypeControl: false, streetViewControl: false,
  });
  gmap.addListener('click', (e)=>{
    setClickMarker(e.latLng);
    document.getElementById('lat').value = e.latLng.lat().toFixed(6);
    document.getElementById('lng').value = e.latLng.lng().toFixed(6);
  });
  const input = document.getElementById('direccion');
  if (input){
    await ensureGoogleReady();
    placeAutocomplete = new google.maps.places.Autocomplete(input, { fields: ['geometry'] });
    placeAutocomplete.addListener('place_changed', ()=>{
      const place = placeAutocomplete.getPlace();
      if (place && place.geometry){
        const pos = place.geometry.location;
        gmap.setCenter(pos); gmap.setZoom(14);
        setClickMarker(pos);
        document.getElementById('lat').value = pos.lat().toFixed(6);
        document.getElementById('lng').value = pos.lng().toFixed(6);
      }
    });
  }
  const btn = document.getElementById('btnUbicacion');
  if(btn){
    btn.addEventListener('click', ()=>{
      if(!navigator.geolocation){ setBanner('Tu dispositivo no permite geolocalización', 'error'); return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const { latitude, longitude } = pos.coords;
        const latLng = { lat: latitude, lng: longitude };
        gmap.setCenter(latLng); gmap.setZoom(15);
        setClickMarker(latLng);
        document.getElementById('lat').value = latitude.toFixed(6);
        document.getElementById('lng').value = longitude.toFixed(6);
      }, (err)=>{ setBanner('No se pudo leer tu ubicación ('+err.message+')','error'); });
    });
  }
}
function setClickMarker(latLng){
  if(clickMarker){ clickMarker.setMap(null); }
  clickMarker = new google.maps.Marker({ position: latLng, map: gmap, animation: google.maps.Animation.DROP });
}

// ========= CSV/PDF =========
function exportCSV(rows){
  const header = ['fecha_inicio','hora_inicio','fecha_fin','hora_fin','tecnico','tipo','garantia','cobrado','monto','cliente','telefono','ciudad','notas','lat','lng'];
  const lines = [header.join(',')].concat(rows.map(r=> header.map(h=> {
    const val = (r[h]!==undefined && r[h]!==null)? String(r[h]).replaceAll('"','""') : '';
    return `"${val}"`;
  }).join(',')));
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `mdc-servicio-${state.month}.csv`; a.click();
  URL.revokeObjectURL(url);
}

async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const node = document.body;
  const canvas = await html2canvas(node, { scale: 2, useCORS:true });
  const imgData = canvas.toDataURL('image/png');
  const pdf = new jsPDF('p','mm','a4');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const imgWidth = pageWidth;
  const imgHeight = canvas.height * imgWidth / canvas.width;
  let position = 0;
  let heightLeft = imgHeight;
  pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
  heightLeft -= pageHeight;
  while (heightLeft > 0) {
    position = heightLeft - imgHeight;
    pdf.addPage();
    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;
  }
  pdf.save(`MDC-Reporte-${state.month}.pdf`);
}

// ========= Render =========
function renderAll(){
  const rows = getFiltered();
  renderKPIs(rows);
  renderCharts(rows);
  renderTable(rows);
}

// ========= Bind =========
function bindUI(){
  document.getElementById('fTecnico').addEventListener('change', e=>{ state.filters.tecnico = e.target.value; renderAll(); });
  document.getElementById('fTipo').addEventListener('change', e=>{ state.filters.tipo = e.target.value; renderAll(); });
  document.getElementById('fGarantia').addEventListener('change', e=>{ state.filters.garantia = e.target.value; renderAll(); });
  document.getElementById('fBusqueda').addEventListener('input', e=>{ state.filters.q = e.target.value; renderAll(); });
  document.getElementById('btnExportCSV').addEventListener('click', ()=> exportCSV(getFiltered()));
  document.getElementById('exportPdfBtn').addEventListener('click', exportPDF);

  const cobradoSel = document.getElementById('cobrado');
  const montoInp = document.getElementById('monto');
  function toggleMonto(){
    const isYes = cobradoSel.value === 'Sí';
    montoInp.disabled = !isYes;
    if(!isYes){ montoInp.value = ''; }
  }
  cobradoSel.addEventListener('change', toggleMonto); toggleMonto();

  // Captura
  const form = document.getElementById('form');
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const payload = Object.fromEntries(fd.entries());

    // Validaciones básicas
    const start = dayjs(`${payload.fecha_inicio} ${payload.hora_inicio}`, 'YYYY-MM-DD HH:mm');
    const end   = dayjs(`${payload.fecha_fin} ${payload.hora_fin}`, 'YYYY-MM-DD HH:mm');
    if(!start.isValid() || !end.isValid() || end.isBefore(start)){
      setBanner('Revisa fechas/horas: el fin no puede ser antes que el inicio.', 'error');
      return;
    }
    if(payload.cobrado === 'Sí'){
      payload.monto = payload.monto ? Number(payload.monto) : 0;
      if(!(payload.monto >= 0)){ setBanner('Monto inválido.', 'error'); return; }
    }else{
      payload.monto = 0;
    }

    // Lat/Lng
    const latInp = document.getElementById('lat');
    const lngInp = document.getElementById('lng');
    payload.lat = latInp.value ? Number(latInp.value) : undefined;
    payload.lng = lngInp.value ? Number(lngInp.value) : undefined;

    // Actualiza libreta de clientes
    upsertClient(payload.cliente, payload.telefono);

    await saveRow(payload);
    form.reset();
  });
}

// ========= Init =========
(async function(){
  lucide.createIcons();
  initMonthSelect();
  bindUI();
  await loadData();
  renderAll();
})();
</script>
</body>
</html>
